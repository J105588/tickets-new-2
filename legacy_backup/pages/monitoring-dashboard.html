<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âº∑ÂåñÂ∫ßÂ∏≠Áõ£Ë¶ñ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - Â∫ßÂ∏≠ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script>
        (async () => {
            try {
                const res = await fetch('../manifest.json', { cache: 'no-store' });
                const manifest = await res.json();
                const bg = (manifest && (manifest.background_color || manifest.theme_color)) || null;
                if (!bg) return;
                const theme = bg;
                const isWhite = (typeof bg === 'string') && (/^#?([fF]{3}|[fF]{6})$/.test(bg) || bg.toLowerCase() === 'white');
                const pageBg = isWhite ? '#f5f6f8' : bg;
                let themeMeta = document.querySelector('meta[name="theme-color"]');
                if (!themeMeta) {
                    themeMeta = document.createElement('meta');
                    themeMeta.setAttribute('name', 'theme-color');
                    document.head.appendChild(themeMeta);
                }
                themeMeta.setAttribute('content', theme);
                try { document.documentElement.style.backgroundColor = pageBg; } catch (_) { }
                try { document.body && (document.body.style.backgroundColor = pageBg); } catch (_) { }
                const toRgb = (hex) => {
                    const h = hex.replace('#', '').trim();
                    if (h.length === 3) return [h[0] + h[0], h[1] + h[1], h[2] + h[2]].map(v => parseInt(v, 16));
                    if (h.length === 6) return [h.substring(0, 2), h.substring(2, 4), h.substring(4, 6)].map(v => parseInt(v, 16));
                    return null;
                };
                const rgb = /^#?[0-9a-fA-F]{3,6}$/.test(theme) ? toRgb(theme) : null;
                if (rgb) {
                    const [r, g, b] = rgb.map(v => v / 255);
                    const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                    const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
                    if (appleMeta) appleMeta.setAttribute('content', luminance < 0.5 ? 'black' : 'default');
                }
            } catch (_) { }
        })();
    </script>
    <style>
        .monitoring-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        .dashboard-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin: 0;
        }

        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }

        .status-card:hover {
            transform: translateY(-2px);
        }

        .status-card.full {
            border-left-color: #e74c3c;
        }

        .status-card.critical {
            border-left-color: #f39c12;
        }

        .status-card.warning {
            border-left-color: #f1c40f;
        }

        .status-card.normal {
            border-left-color: #27ae60;
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .status-count {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
        }

        .status-description {
            font-size: 14px;
            color: #666;
            margin: 5px 0 0 0;
        }

        .monitoring-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .monitoring-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-indicator.running {
            background: #27ae60;
            color: white;
        }

        .status-indicator.stopped {
            background: #e74c3c;
            color: white;
        }

        .control-hint {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        .btn-icon {
            margin-right: 6px;
        }

        .quick-settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .quick-settings h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn-quick {
            padding: 6px 12px;
            border: 1px solid #e1e5e9;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-quick:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-quick.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .control-group input,
        .control-group select {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .timeslots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .timeslot-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .timeslot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        .timeslot-card.full {
            border-left-color: #e74c3c;
        }

        .timeslot-card.critical {
            border-left-color: #f39c12;
        }

        .timeslot-card.warning {
            border-left-color: #f1c40f;
        }

        .timeslot-card.normal {
            border-left-color: #27ae60;
        }

        .timeslot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .timeslot-title {
            font-weight: 600;
            font-size: 16px;
            margin: 0;
        }

        .capacity-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .capacity-badge.full {
            background: #e74c3c;
            color: white;
        }

        .capacity-badge.critical {
            background: #f39c12;
            color: white;
        }

        .capacity-badge.warning {
            background: #f1c40f;
            color: #333;
        }

        .capacity-badge.normal {
            background: #27ae60;
            color: white;
        }

        .timeslot-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .timeslot-progress {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-bar.full {
            background: #e74c3c;
        }

        .progress-bar.critical {
            background: #f39c12;
        }

        .progress-bar.warning {
            background: #f1c40f;
        }

        .progress-bar.normal {
            background: #27ae60;
        }

        .last-updated {
            font-size: 12px;
            color: #999;
            text-align: right;
        }

        .statistics-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item-large {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value-large {
            font-size: 36px;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: #333;
        }

        .stat-label-large {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e1e5e9;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .notification-history {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .notification-item {
            padding: 10px;
            border-left: 3px solid;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .notification-item.high {
            border-left-color: #e74c3c;
        }

        .notification-item.medium {
            border-left-color: #f39c12;
        }

        .notification-item.low {
            border-left-color: #27ae60;
        }

        .notification-text {
            font-weight: 600;
            margin: 0 0 5px 0;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        /* „ÇØ„É©„ÇπÂà•ÂàÜÊûê„Éë„Éç„É´ */
        .class-analysis-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .class-analysis-panel h3 {
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .class-buttons-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .class-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .class-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .class-button:active {
            transform: translateY(-1px);
        }

        .class-button.loading {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .class-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .class-button .class-name {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .class-button .class-stats {
            display: block;
            font-size: 14px;
            opacity: 0.9;
        }

        .class-button .class-description {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .network-status-indicator {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
            animation: pulse 2s infinite;
        }

        .network-status-indicator.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        .network-status-indicator.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);
            animation: none;
        }

        .network-status-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .network-status-icon {
            font-size: 20px;
        }

        .network-status-text {
            flex: 1;
            font-weight: 600;
        }

        .network-retry-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .network-retry-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 30px;
        }

        .performance-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid;
        }

        .detail-card.reserved {
            border-left-color: #667eea;
        }

        .detail-card.checked-in {
            border-left-color: #27ae60;
        }

        .detail-card.warning {
            border-left-color: #f39c12;
        }

        .detail-card h4 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .checkin-rate-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #27ae60;
            text-align: center;
        }

        .detail-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: #333;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .occupancy-rate {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
            margin-top: 10px;
        }

        .loading-modal {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-modal::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e1e5e9;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .monitoring-dashboard {
                padding: 10px;
            }

            .dashboard-title {
                font-size: 24px;
            }

            .status-indicators {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .timeslots-grid {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .class-buttons-container {
                grid-template-columns: 1fr;
            }

            .class-button {
                padding: 15px;
                font-size: 14px;
            }

            .class-button .class-name {
                font-size: 16px;
            }

            .class-button .class-stats {
                font-size: 13px;
            }

            .class-button .class-description {
                font-size: 11px;
            }

            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }

            .modal-header {
                padding: 15px;
            }

            .modal-title {
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            .performance-details {
                grid-template-columns: 1fr;
            }

            .detail-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="monitoring-dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Âº∑ÂåñÂ∫ßÂ∏≠Áõ£Ë¶ñ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
            <p class="dashboard-subtitle">„É™„Ç¢„É´„Çø„Ç§„É†Â∫ßÂ∏≠Áä∂Ê≥ÅÁõ£Ë¶ñ„ÉªÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†</p>
        </div>

        <div id="error-container" class="error-message" style="display: none;">
            <span id="error-message"></span>
        </div>

        <div id="success-container" class="success-message" style="display: none;">
            <span id="success-message"></span>
        </div>

        <!-- „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div id="network-status" class="network-status-indicator" style="display: none;">
            <div class="network-status-content">
                <span class="network-status-icon">üåê</span>
                <span class="network-status-text">„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç‰∏≠...</span>
                <button class="network-retry-btn" onclick="window.MonitoringDashboard.retryConnection()">ÂÜçË©¶Ë°å</button>
            </div>
        </div>

        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div class="status-indicators">
            <div class="status-card full">
                <h3>Ê∫ÄÂ∏≠</h3>
                <p class="status-count" id="full-count">0</p>
                <p class="status-description">Á©∫Â∏≠„Å™„Åó</p>
            </div>
            <div class="status-card critical">
                <h3>Á∑äÊÄ•</h3>
                <p class="status-count" id="critical-count">0</p>
                <p class="status-description">2Â∏≠‰ª•‰∏ã</p>
            </div>
            <div class="status-card warning">
                <h3>Ë≠¶Âëä</h3>
                <p class="status-count" id="warning-count">0</p>
                <p class="status-description">5Â∏≠‰ª•‰∏ã</p>
            </div>
            <div class="status-card normal">
                <h3>Ê≠£Â∏∏</h3>
                <p class="status-count" id="normal-count">0</p>
                <p class="status-description">6Â∏≠‰ª•‰∏ä</p>
            </div>
        </div>

        <!-- Áõ£Ë¶ñ„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="monitoring-controls">
            <div class="controls-header">
                <h3>Áõ£Ë¶ñË®≠ÂÆö</h3>
                <div class="monitoring-status">
                    <span class="status-indicator" id="monitoring-status-indicator">ÂÅúÊ≠¢‰∏≠</span>
                </div>
            </div>

            <!-- GAS URL ÊÉÖÂ†±„Å®„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥Êìç‰Ωú -->
            <div id="api-url-panel"
                style="margin-bottom:12px;background:#f8f9fa;border:1px solid #e1e5e9;border-radius:8px;padding:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <span style="font-weight:600;color:#333;">Êé•Á∂öÂÖàGAS:</span>
                <span id="api-url-label"
                    style="font-family:monospace;font-size:12px;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:540px;">--</span>
                <span id="api-url-meta" style="font-size:12px;color:#666;">(--)</span>
                <button id="api-url-refresh" class="btn btn-secondary" style="padding:6px 10px;">Êõ¥Êñ∞</button>
                <button id="api-url-random" class="btn btn-secondary" style="padding:6px 10px;">„É©„É≥„ÉÄ„É†ÂàáÊõø</button>
            </div>

            <div class="controls-grid">
                <div class="control-group">
                    <label for="check-interval">„ÉÅ„Çß„ÉÉ„ÇØÈñìÈöî (Áßí)</label>
                    <input type="number" id="check-interval" value="15" min="5" max="300">
                    <small class="control-hint">5-300Áßí„ÅÆÁØÑÂõ≤„ÅßË®≠ÂÆö</small>
                </div>
                <div class="control-group">
                    <label for="warning-threshold">Ë≠¶ÂëäÈñæÂÄ§ (Â∏≠)</label>
                    <input type="number" id="warning-threshold" value="5" min="1" max="20">
                    <small class="control-hint">„Åì„ÅÆÂ∏≠Êï∞‰ª•‰∏ã„ÅßË≠¶ÂëäÈÄöÁü•</small>
                </div>
                <div class="control-group">
                    <label for="critical-threshold">Á∑äÊÄ•ÈñæÂÄ§ (Â∏≠)</label>
                    <input type="number" id="critical-threshold" value="2" min="0" max="10">
                    <small class="control-hint">„Åì„ÅÆÂ∏≠Êï∞‰ª•‰∏ã„ÅßÁ∑äÊÄ•ÈÄöÁü•</small>
                </div>
                <div class="control-group">
                    <label for="cooldown-period">ÈÄöÁü•„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ (ÂàÜ)</label>
                    <input type="number" id="cooldown-period" value="5" min="1" max="60">
                    <small class="control-hint">Âêå„ÅòÂÖ¨Êºî„Å∏„ÅÆÈáçË§áÈÄöÁü•„ÇíÈò≤„Åê</small>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" id="start-monitoring">
                    <span class="btn-icon">‚ñ∂</span>
                    Áõ£Ë¶ñÈñãÂßã
                </button>
                <button class="btn btn-danger" id="stop-monitoring" disabled>
                    <span class="btn-icon">‚èπ</span>
                    Áõ£Ë¶ñÂÅúÊ≠¢
                </button>
                <button class="btn btn-success" id="manual-check">
                    <span class="btn-icon">üîÑ</span>
                    ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØ
                </button>
                <button class="btn btn-secondary" id="update-settings">
                    <span class="btn-icon">‚öôÔ∏è</span>
                    Ë®≠ÂÆöÊõ¥Êñ∞
                </button>
                <button class="btn btn-secondary" id="clear-history">
                    <span class="btn-icon">üóëÔ∏è</span>
                    Â±•Ê≠¥„ÇØ„É™„Ç¢
                </button>
                <button class="btn btn-secondary" id="test-notification">
                    <span class="btn-icon">üìß</span>
                    „ÉÜ„Çπ„ÉàÈÄöÁü•
                </button>
            </div>

            <div class="quick-settings">
                <h4>„ÇØ„Ç§„ÉÉ„ÇØË®≠ÂÆö</h4>
                <div class="quick-buttons">
                    <button class="btn-quick" data-interval="10">10ÁßíÈñìÈöî</button>
                    <button class="btn-quick" data-interval="30">30ÁßíÈñìÈöî</button>
                    <button class="btn-quick" data-interval="60">1ÂàÜÈñìÈöî</button>
                    <button class="btn-quick" data-warning="3">Ë≠¶Âëä3Â∏≠</button>
                    <button class="btn-quick" data-warning="5">Ë≠¶Âëä5Â∏≠</button>
                    <button class="btn-quick" data-critical="1">Á∑äÊÄ•1Â∏≠</button>
                    <button class="btn-quick" data-critical="2">Á∑äÊÄ•2Â∏≠</button>
                </div>
            </div>
        </div>

        <!-- Áµ±Ë®à„Éë„Éç„É´ -->
        <div class="statistics-panel">
            <h3>„Ç∑„Çπ„ÉÜ„É†Áµ±Ë®à</h3>
            <div class="statistics-grid">
                <div class="stat-item-large">
                    <p class="stat-value-large" id="total-checks">0</p>
                    <p class="stat-label-large">Á∑è„ÉÅ„Çß„ÉÉ„ÇØÂõûÊï∞</p>
                </div>
                <div class="stat-item-large">
                    <p class="stat-value-large" id="total-notifications">0</p>
                    <p class="stat-label-large">Á∑èÈÄöÁü•ÂõûÊï∞</p>
                </div>
                <div class="stat-item-large">
                    <p class="stat-value-large" id="average-empty">0</p>
                    <p class="stat-label-large">Âπ≥ÂùáÁ©∫Â∏≠Êï∞</p>
                </div>
                <div class="stat-item-large">
                    <p class="stat-value-large" id="last-check-time">--:--</p>
                    <p class="stat-label-large">ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ</p>
                </div>
            </div>
        </div>

        <!-- ÈÄöÁü•Â±•Ê≠¥ -->
        <div class="notification-history">
            <h3>ÈÄöÁü•Â±•Ê≠¥</h3>
            <div id="notification-list">
                <p style="text-align: center; color: #666; padding: 20px;">ÈÄöÁü•Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <!-- „ÇØ„É©„ÇπÂà•ÂàÜÊûê„Éë„Éç„É´ -->
        <div class="class-analysis-panel">
            <h3>„ÇØ„É©„ÇπÂà•ÂàÜÊûê</h3>
            <div class="class-buttons-container">
                <div class="loading">„ÇØ„É©„ÇπÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </div>

        <!-- ÂÖ¨Êºî‰∏ÄË¶ß -->
        <div id="timeslots-container">
            <div class="loading">Â∫ßÂ∏≠„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>

    <script type="module">
        import GasAPI from './api.js';
        import enhancedStatusMonitor from './enhanced-status-monitor.js';

        class MonitoringDashboard {
            constructor() {
                this.isMonitoring = false;
                this.updateInterval = null;
                this.notificationHistory = [];
                this.currentData = null;
                this.isRefreshing = false;
                this.isSendingEmail = false;
                this.nextEmailCheckAt = 0;
                this.lastEmailSignature = '';
                this.latestTimeslotMap = new Map();
                this.urlRotationInterval = null;
                this.offlineCheckInterval = null;

                this.initializeElements();
                this.bindEvents();
                this.loadInitialData();
                this.startUrlAutoRotation();
            }

            initializeElements() {
                this.elements = {
                    checkInterval: document.getElementById('check-interval'),
                    warningThreshold: document.getElementById('warning-threshold'),
                    criticalThreshold: document.getElementById('critical-threshold'),
                    cooldownPeriod: document.getElementById('cooldown-period'),
                    startMonitoring: document.getElementById('start-monitoring'),
                    stopMonitoring: document.getElementById('stop-monitoring'),
                    manualCheck: document.getElementById('manual-check'),
                    updateSettings: document.getElementById('update-settings'),
                    clearHistory: document.getElementById('clear-history'),
                    testNotification: document.getElementById('test-notification'),
                    timeslotsContainer: document.getElementById('timeslots-container'),
                    notificationList: document.getElementById('notification-list'),
                    errorContainer: document.getElementById('error-container'),
                    successContainer: document.getElementById('success-container'),
                    errorMessage: document.getElementById('error-message'),
                    successMessage: document.getElementById('success-message'),
                    apiUrlLabel: document.getElementById('api-url-label'),
                    apiUrlMeta: document.getElementById('api-url-meta'),
                    apiUrlRefresh: document.getElementById('api-url-refresh'),
                    apiUrlRandom: document.getElementById('api-url-random'),
                    classButtonsContainer: document.querySelector('.class-buttons-container'),
                    networkStatus: document.getElementById('network-status'),
                    networkStatusText: document.querySelector('.network-status-text')
                };
            }

            bindEvents() {
                this.elements.startMonitoring.addEventListener('click', () => this.startMonitoring());
                this.elements.stopMonitoring.addEventListener('click', () => this.stopMonitoring());
                this.elements.manualCheck.addEventListener('click', () => this.manualCheck());
                this.elements.updateSettings.addEventListener('click', () => this.updateSettings());
                this.elements.clearHistory.addEventListener('click', () => this.clearHistory());
                this.elements.testNotification.addEventListener('click', () => this.testNotification());

                // „ÇØ„Ç§„ÉÉ„ÇØË®≠ÂÆö„Éú„Çø„É≥
                document.querySelectorAll('.btn-quick').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleQuickSetting(e.target));
                });

                // Ë®≠ÂÆöÂÄ§„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                this.elements.checkInterval.addEventListener('change', () => this.updateStatusIndicator());
                this.elements.warningThreshold.addEventListener('change', () => this.updateStatusIndicator());
                this.elements.criticalThreshold.addEventListener('change', () => this.updateStatusIndicator());
                this.elements.cooldownPeriod.addEventListener('change', () => this.updateStatusIndicator());

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≤ÂΩì„ÇØ„É©„Çπ‰∏ÄË¶ß„ÇíË°®Á§∫
                const fullCard = document.querySelector('.status-card.full');
                const criticalCard = document.querySelector('.status-card.critical');
                const warningCard = document.querySelector('.status-card.warning');
                const normalCard = document.querySelector('.status-card.normal');
                if (fullCard) fullCard.addEventListener('click', () => this.showStatusListModal('full'));
                if (criticalCard) criticalCard.addEventListener('click', () => this.showStatusListModal('critical'));
                if (warningCard) warningCard.addEventListener('click', () => this.showStatusListModal('warning'));
                if (normalCard) normalCard.addEventListener('click', () => this.showStatusListModal('normal'));

                // GAS URL ÊÉÖÂ†±
                this.elements.apiUrlRefresh.addEventListener('click', () => this.refreshUrlInfo());
                this.elements.apiUrlRandom.addEventListener('click', async () => {
                    try { await GasAPI.selectRandomUrl(); } catch (_) { }
                    await this.refreshUrlInfo();
                });
                // ÂàùÊúüË°®Á§∫
                this.refreshUrlInfo();
            }

            async loadInitialData() {
                try {
                    this.showLoading();

                    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!this.checkNetworkConnection()) {
                        await this.handleOfflineMode();
                        return;
                    }

                    // „Åæ„Åö„Ç∞„É´„Éº„Éó‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„ÄÅ„Ç∞„É´„Éº„ÉóÂçò‰Ωç„ÅßË©≥Á¥∞ÂàÜÊûê„ÇíÈõÜÁ¥Ñ
                    let allTimeslots = [];
                    let summaryAgg = { totalTimeslots: 0, fullCapacity: 0, warningCapacity: 0, criticalCapacity: 0, normalCapacity: 0, totalSeats: 0, totalOccupied: 0, totalEmpty: 0 };
                    const groups = await GasAPI.getGroups();
                    if (Array.isArray(groups) && groups.length > 0) {
                        for (let i = 0; i < groups.length; i++) {
                            const g = groups[i];
                            // ÈÅéÂ∫¶„Å™‰∏¶Âàó„ÇíÈÅø„Åë„ÇãÔºàAPIË≤†Ëç∑„Å®URLÈï∑ÂØæÁ≠ñÔºâ
                            if (i > 0) { await new Promise(r => setTimeout(r, 150)); }
                            const resp = await GasAPI.getDetailedCapacityAnalysis(g, null, null);
                            if (resp && resp.success && resp.analysis) {
                                const t = Array.isArray(resp.analysis.timeslots) ? resp.analysis.timeslots : [];
                                allTimeslots = allTimeslots.concat(t);
                                const s = resp.analysis.summary || {};
                                summaryAgg.totalTimeslots += s.totalTimeslots || 0;
                                summaryAgg.fullCapacity += s.fullCapacity || 0;
                                summaryAgg.warningCapacity += s.warningCapacity || 0;
                                summaryAgg.criticalCapacity += s.criticalCapacity || 0;
                                summaryAgg.normalCapacity += s.normalCapacity || 0;
                                summaryAgg.totalSeats += s.totalSeats || 0;
                                summaryAgg.totalOccupied += s.totalOccupied || 0;
                                summaryAgg.totalEmpty += s.totalEmpty || 0;
                            }
                        }
                        this.currentData = { summary: summaryAgg, timeslots: allTimeslots, capacityDistribution: {}, trends: [] };
                        this.mergeTimeslots(allTimeslots);
                        this.notifyNewClasses(this.currentData);
                        this.updateDashboard();
                        this.updateQuickButtonStates();
                        this.updateStatusIndicator();
                        this.nextEmailCheckAt = Date.now();
                        this.maybeTriggerScheduledEmail();
                    } else {
                        // „Ç∞„É´„Éº„ÉóÂèñÂæó„Å´Â§±Êïó/Á©∫ ‚Üí Êó¢Â≠ò„ÅÆ‰∏ÄÊã¨ÂèñÂæó„Å∏„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        const response = await GasAPI.getDetailedCapacityAnalysis();
                        if (response.success) {
                            this.currentData = response.analysis || {};
                            const list = Array.isArray(this.currentData.timeslots) ? this.currentData.timeslots : [];
                            if (list.length === 0) {
                                await this.loadWithFallback('Ë©≥Á¥∞„Éá„Éº„Çø„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰ΩøÁî®');
                                await this.initializeClassAnalysis();
                                return;
                            }
                            this.mergeTimeslots(list);
                            this.notifyNewClasses(this.currentData);
                            this.updateDashboard();
                            this.updateQuickButtonStates();
                            this.updateStatusIndicator();
                            this.nextEmailCheckAt = Date.now();
                            this.maybeTriggerScheduledEmail();
                        } else {
                            await this.loadWithFallback('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (response.message || ''));
                        }
                    }

                    // „ÇØ„É©„ÇπÂà•ÂàÜÊûê„ÅÆÂàùÊúüÂåñ
                    await this.initializeClassAnalysis();
                } catch (error) {
                    console.error('Initial data load error:', error);

                    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Âá¶ÁêÜ
                    if (this.isNetworkError(error)) {
                        await this.handleNetworkError(error);
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Çø„Ç§„É†„Ç¢„Ç¶„Éà/„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ‰æãÂ§ñÊôÇ
                        await this.loadWithFallback('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    }

                    // „Ç®„É©„ÉºÊôÇ„ÇÇ„ÇØ„É©„ÇπÂà•ÂàÜÊûê„ÇíË©¶Ë°å
                    await this.initializeClassAnalysis();
                }
            }

            async loadWithFallback(baseMessage) {
                try {
                    const fallback = await GasAPI.getFullCapacityTimeslots();
                    if (fallback && fallback.success !== false) {
                        this.currentData = this.buildMinimalAnalysisFromFullCapacity(fallback);
                        this.mergeTimeslots(this.currentData.timeslots || []);
                        this.notifyNewClasses(this.currentData);
                        this.updateDashboard();
                        this.updateQuickButtonStates();
                        this.updateStatusIndicator();
                        this.showSuccess((baseMessage ? baseMessage + ' ' : '') + 'Á∞°ÊòìË°®Á§∫„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
                        // ÂàùÂõû„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åß„ÇÇÂç≥ÊôÇÈÄÅ‰ø°Âà§ÂÆö
                        this.nextEmailCheckAt = Date.now();
                        this.maybeTriggerScheduledEmail();
                        return;
                    }
                    this.showError(baseMessage || '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                } catch (e) {
                    this.showError((baseMessage ? baseMessage + ' ' : '') + '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å´„ÇÇÂ§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
                }
            }

            buildMinimalAnalysisFromFullCapacity(fallbackResponse) {
                // ÊúüÂæÖ„Åô„ÇãÂΩ¢„Å´Ê≠£Ë¶èÂåñ
                const timeslots = [];
                const list = fallbackResponse.timeslots || fallbackResponse.data || fallbackResponse.result || [];
                const now = new Date();
                for (const item of list) {
                    // ÊÉ≥ÂÆö„Åï„Çå„Çã„Éï„Ç£„Éº„É´„ÉâÂêç„Å´ÂπÖ„ÇíÊåÅ„Åü„Åõ„Çã
                    const group = item.group || item.g || item.grp || '‰∏çÊòé';
                    const day = (item.day || item.d || 1).toString();
                    const timeslot = item.timeslot || item.slot || item.t || 'A';
                    const totalSeats = item.totalSeats || item.total || 0;
                    const emptySeats = item.emptySeats != null ? item.emptySeats : 0;
                    const occupiedSeats = totalSeats > 0 ? Math.max(0, totalSeats - emptySeats) : (item.occupiedSeats || 0);
                    timeslots.push({
                        group,
                        day,
                        timeslot,
                        totalSeats,
                        occupiedSeats,
                        emptySeats,
                        isFull: emptySeats === 0,
                        capacityLevel: emptySeats === 0 ? 'full' : (emptySeats <= 2 ? 'critical' : (emptySeats <= 5 ? 'warning' : 'normal')),
                        lastChecked: now
                    });
                }

                const summary = {
                    totalTimeslots: timeslots.length,
                    fullCapacity: timeslots.filter(t => t.capacityLevel === 'full').length,
                    criticalCapacity: timeslots.filter(t => t.capacityLevel === 'critical').length,
                    warningCapacity: timeslots.filter(t => t.capacityLevel === 'warning').length,
                    normalCapacity: timeslots.filter(t => t.capacityLevel === 'normal').length,
                    totalSeats: timeslots.reduce((s, t) => s + (t.totalSeats || 0), 0),
                    totalOccupied: timeslots.reduce((s, t) => s + (t.occupiedSeats || 0), 0),
                    totalEmpty: timeslots.reduce((s, t) => s + (t.emptySeats || 0), 0)
                };

                return {
                    summary,
                    timeslots,
                    capacityDistribution: {},
                    trends: []
                };
            }

            async startMonitoring() {
                try {
                    // Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
                    await this.updateSettings();

                    // Áõ£Ë¶ñÈñãÂßã
                    enhancedStatusMonitor.start();
                    this.isMonitoring = true;

                    // ÂÆöÊúüÊõ¥Êñ∞„ÇíÈñãÂßã
                    this.startPeriodicUpdate();

                    this.elements.startMonitoring.disabled = true;
                    this.elements.stopMonitoring.disabled = false;

                    this.updateStatusIndicator();
                    this.showSuccess('Áõ£Ë¶ñ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    this.showError('Áõ£Ë¶ñÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            stopMonitoring() {
                enhancedStatusMonitor.stop();
                this.isMonitoring = false;

                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }

                this.elements.startMonitoring.disabled = false;
                this.elements.stopMonitoring.disabled = true;

                this.updateStatusIndicator();
                this.showSuccess('Áõ£Ë¶ñ„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
            }

            async manualCheck() {
                try {
                    this.showLoading();
                    await enhancedStatusMonitor.manualCheck();
                    await this.loadInitialData();
                    this.showSuccess('ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    this.showError('ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            async updateSettings() {
                try {
                    const settings = {
                        checkInterval: parseInt(this.elements.checkInterval.value) * 1000,
                        warningThreshold: parseInt(this.elements.warningThreshold.value),
                        criticalThreshold: parseInt(this.elements.criticalThreshold.value),
                        notificationCooldown: parseInt(this.elements.cooldownPeriod.value) * 60 * 1000
                    };

                    enhancedStatusMonitor.updateCapacityThresholds({
                        warning: settings.warningThreshold,
                        critical: settings.criticalThreshold,
                        full: 0
                    });

                    enhancedStatusMonitor.setCheckInterval(settings.checkInterval);
                    enhancedStatusMonitor.setNotificationCooldown(settings.notificationCooldown);

                    this.showSuccess('Ë®≠ÂÆö„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    this.showError('Ë®≠ÂÆöÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            clearHistory() {
                enhancedStatusMonitor.clearNotificationHistory();
                this.notificationHistory = [];
                this.updateNotificationHistory();
                this.showSuccess('ÈÄöÁü•Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            }

            async testNotification() {
                try {
                    const testData = {
                        emails: ['jxjin2010@gmail.com'], // „ÉÜ„Çπ„ÉàÁî®„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
                        notifications: [{
                            timeslot: {
                                group: '„ÉÜ„Çπ„Éà',
                                day: '1',
                                timeslot: 'A',
                                emptySeats: 0,
                                totalSeats: 50,
                                isFull: true
                            },
                            change: {
                                type: 'capacity_status',
                                from: 'available',
                                to: 'full'
                            },
                            priority: 'high'
                        }],
                        statistics: enhancedStatusMonitor.getStatistics(),
                        timestamp: new Date().toISOString(),
                        isTest: true
                    };

                    const response = await GasAPI.sendStatusNotificationEmail(testData);
                    if (response.success) {
                        this.showSuccess('„ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
                    } else {
                        this.showError('„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + response.message);
                    }
                } catch (error) {
                    this.showError('„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅÆÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            handleQuickSetting(button) {
                const interval = button.dataset.interval;
                const warning = button.dataset.warning;
                const critical = button.dataset.critical;

                if (interval) {
                    this.elements.checkInterval.value = interval;
                    this.updateQuickButtonStates();
                    this.showSuccess(`„ÉÅ„Çß„ÉÉ„ÇØÈñìÈöî„Çí${interval}Áßí„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`);
                }

                if (warning) {
                    this.elements.warningThreshold.value = warning;
                    this.updateQuickButtonStates();
                    this.showSuccess(`Ë≠¶ÂëäÈñæÂÄ§„Çí${warning}Â∏≠„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`);
                }

                if (critical) {
                    this.elements.criticalThreshold.value = critical;
                    this.updateQuickButtonStates();
                    this.showSuccess(`Á∑äÊÄ•ÈñæÂÄ§„Çí${critical}Â∏≠„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`);
                }

                this.updateStatusIndicator();
            }

            updateQuickButtonStates() {
                // ÁèæÂú®„ÅÆË®≠ÂÆöÂÄ§„Å´Âü∫„Å•„ÅÑ„Å¶„ÇØ„Ç§„ÉÉ„ÇØ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                document.querySelectorAll('.btn-quick').forEach(btn => {
                    btn.classList.remove('active');

                    const interval = btn.dataset.interval;
                    const warning = btn.dataset.warning;
                    const critical = btn.dataset.critical;

                    if (interval && parseInt(interval) === parseInt(this.elements.checkInterval.value)) {
                        btn.classList.add('active');
                    }
                    if (warning && parseInt(warning) === parseInt(this.elements.warningThreshold.value)) {
                        btn.classList.add('active');
                    }
                    if (critical && parseInt(critical) === parseInt(this.elements.criticalThreshold.value)) {
                        btn.classList.add('active');
                    }
                });
            }

            updateStatusIndicator() {
                const indicator = document.getElementById('monitoring-status-indicator');
                if (this.isMonitoring) {
                    indicator.textContent = 'Áõ£Ë¶ñ‰∏≠';
                    indicator.className = 'status-indicator running';
                } else {
                    indicator.textContent = 'ÂÅúÊ≠¢‰∏≠';
                    indicator.className = 'status-indicator stopped';
                }
            }

            startPeriodicUpdate() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }

                const interval = parseInt(this.elements.checkInterval.value) * 1000;
                this.updateInterval = setInterval(() => {
                    this.refreshInBackground();
                }, interval);
            }

            async refreshInBackground() {
                if (this.isRefreshing) return;
                this.isRefreshing = true;
                try {
                    const response = await GasAPI.getDetailedCapacityAnalysis();
                    if (response && response.success) {
                        this.currentData = response.analysis;
                        this.mergeTimeslots(this.currentData.timeslots || []);
                        this.notifyNewClasses(this.currentData);
                        this.updateDashboard();
                        this.updateQuickButtonStates();
                        this.updateStatusIndicator();
                        this.maybeTriggerScheduledEmail();
                        return;
                    }
                    // fallback silently
                    const fallback = await GasAPI.getFullCapacityTimeslots();
                    if (fallback && fallback.success !== false) {
                        this.currentData = this.buildMinimalAnalysisFromFullCapacity(fallback);
                        this.mergeTimeslots(this.currentData.timeslots || []);
                        this.notifyNewClasses(this.currentData);
                        this.updateDashboard();
                        this.updateQuickButtonStates();
                        this.updateStatusIndicator();
                        this.maybeTriggerScheduledEmail();
                    }
                } catch (e) {
                    // silent failure in background; keep current UI
                    console.warn('[Background Refresh] failed:', e && e.message ? e.message : e);
                } finally {
                    this.isRefreshing = false;
                }
            }

            mergeTimeslots(timeslots) {
                try {
                    if (!Array.isArray(timeslots)) return;
                    for (const t of timeslots) {
                        const id = this.getTimeslotId(t);
                        const normalized = { ...t };
                        if (!normalized.lastChecked) normalized.lastChecked = new Date();
                        this.latestTimeslotMap.set(id, normalized);
                    }
                } catch (_) { }
            }

            getAbnormalTimeslots() {
                if (!this.currentData || !Array.isArray(this.currentData.timeslots)) return [];
                return this.currentData.timeslots.filter(t => {
                    // Ë¶ãÊú¨ÊºîÂäá„ÅØ„É°„Éº„É´ÈÄÅ‰ø°ÂØæË±°Â§ñ
                    if (t.group === 'Ë¶ãÊú¨ÊºîÂäá') return false;
                    // Áï∞Â∏∏„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Åø„ÇíÂØæË±°„Å®„Åô„Çã
                    return t.capacityLevel && t.capacityLevel !== 'normal';
                });
            }

            maybeTriggerScheduledEmail() {
                try {
                    const now = Date.now();
                    if (now < this.nextEmailCheckAt) return;
                    const abnormal = this.getAbnormalTimeslots();
                    if (abnormal.length === 0) {
                        // Ê¨°Âõû„ÉÅ„Çß„ÉÉ„ÇØ„ÅØ5ÂàÜÂæåÔºàÈÄöÁü•ÂØæË±°„ÅåÁÑ°„Åè„Å¶„ÇÇÈñìÈöîÁ∂≠ÊåÅÔºâ
                        this.nextEmailCheckAt = now + 5 * 60 * 1000;
                        return;
                    }
                    const signature = this.buildAbnormalSignature(abnormal);
                    if (signature === this.lastEmailSignature) {
                        // Â§âÂåñ„Å™„Åó ‚Üí „Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ê¨°Âõû„Å∏
                        this.nextEmailCheckAt = now + 5 * 60 * 1000;
                        return;
                    }
                    // ÈÄÅ‰ø°Âá¶ÁêÜ„ÇíÈùûÂêåÊúü„ÅßÂÆüË°å
                    this.sendAbnormalStatusEmail(abnormal).finally(() => {
                        this.lastEmailSignature = signature;
                        this.nextEmailCheckAt = Date.now() + 5 * 60 * 1000;
                    });
                } catch (_) { }
            }

            buildAbnormalSignature(abnormal) {
                try {
                    const parts = abnormal
                        .map(t => {
                            const id = this.getTimeslotId(t);
                            const lvl = t.capacityLevel || '';
                            const empty = Number.isFinite(t.emptySeats) ? t.emptySeats : -1;
                            const occ = Number.isFinite(t.occupiedSeats) ? t.occupiedSeats : -1;
                            return `${id}|${lvl}|${empty}|${occ}`;
                        })
                        .sort();
                    return parts.join('||');
                } catch (_) {
                    return String(Math.random());
                }
            }

            async sendAbnormalStatusEmail(abnormal) {
                try {
                    if (this.isSendingEmail) return;
                    this.isSendingEmail = true;

                    const notifications = abnormal.map(t => ({
                        timeslot: {
                            group: t.group,
                            day: String(t.day),
                            timeslot: t.timeslot,
                            emptySeats: t.emptySeats,
                            totalSeats: t.totalSeats,
                            occupiedSeats: t.occupiedSeats,
                            isFull: t.capacityLevel === 'full',
                            capacityLevel: t.capacityLevel,
                            lastChecked: t.lastChecked
                        },
                        change: {
                            type: 'capacity_status',
                            to: t.capacityLevel
                        },
                        priority: (t.capacityLevel === 'full') ? 'high' : (t.capacityLevel === 'critical' ? 'medium' : 'low')
                    }));

                    const rawStats = (window.enhancedStatusMonitor && window.enhancedStatusMonitor.getStatistics) ? window.enhancedStatusMonitor.getStatistics() : {};
                    const safeStats = {
                        totalChecks: Number((rawStats && rawStats.totalChecks) || 0),
                        totalNotifications: Number((rawStats && rawStats.totalNotifications) || 0),
                        averageEmptySeats: Number(isFinite(rawStats && rawStats.averageEmptySeats) ? rawStats.averageEmptySeats : 0),
                        lastCheckTime: (rawStats && rawStats.lastCheckTime) ? rawStats.lastCheckTime : null
                    };
                    const sum = this.currentData.summary || {};
                    const safeSummary = {
                        totalTimeslots: Number(sum.totalTimeslots || 0),
                        fullCapacity: Number(sum.fullCapacity || 0),
                        criticalCapacity: Number(sum.criticalCapacity || 0),
                        warningCapacity: Number(sum.warningCapacity || 0),
                        normalCapacity: Number(sum.normalCapacity || 0),
                        totalSeats: Number(sum.totalSeats || 0),
                        totalOccupied: Number(sum.totalOccupied || 0),
                        totalEmpty: Number(sum.totalEmpty || 0)
                    };

                    const payload = {
                        notifications,
                        summary: safeSummary,
                        statistics: safeStats,
                        timestamp: new Date().toISOString(),
                        source: 'monitoring-dashboard',
                        subject: `[Â∫ßÂ∏≠Áõ£Ë¶ñ] Áï∞Â∏∏„Çπ„ÉÜ„Éº„Çø„Çπ ${abnormal.length}‰ª∂`,
                        body: this.buildHumanReadableBody(abnormal)
                    };

                    console.log(`[Email Trigger] Áï∞Â∏∏„Çπ„ÉÜ„Éº„Çø„Çπ ${abnormal.length} ‰ª∂„ÄÅÈÄÅ‰ø°ÈñãÂßã`);
                    const resp = await GasAPI.sendStatusNotificationEmail(payload);
                    if (resp && resp.success) {
                        console.log('[Email Trigger] ÈÄÅ‰ø°ÊàêÂäü');
                    } else {
                        console.warn('[Email Trigger] ÈÄÅ‰ø°Â§±Êïó', resp);
                    }
                } catch (e) {
                    console.warn('[Email Trigger] ‰æãÂ§ñ', e && e.message ? e.message : e);
                } finally {
                    this.isSendingEmail = false;
                }
            }

            buildHumanReadableBody(abnormal) {
                try {
                    const header = `Â∫ßÂ∏≠Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÈÄöÁü•\n\nÂØæË±°: Áï∞Â∏∏„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂÖ¨Êºî (${abnormal.length}‰ª∂)\nÊôÇÂàª: ${new Date().toLocaleString('ja-JP')}\n\n`;
                    const sections = abnormal.map(t => {
                        const title = `ÂÖ¨ÊºîÔºö${t.group} ${String(t.day)}Êó•ÁõÆ ${t.timeslot}`;
                        const status = `ÁèæÂú®„ÅÆÁä∂Ê≥ÅÔºö${this.getCapacityLevelText(t.capacityLevel || 'normal')}`;
                        const remain = `ÊÆã„ÇäÔºö${Number.isFinite(t.emptySeats) ? t.emptySeats : 0}/${Number.isFinite(t.totalSeats) ? t.totalSeats : 0} Â∏≠`;
                        const last = `ÊúÄÁµÇÊõ¥Êñ∞Ôºö${t.lastChecked ? new Date(t.lastChecked).toLocaleString('ja-JP') : '-'}`;
                        return `${title}\n${status}\n${remain}\n${last}\n--------`;
                    }).join('\n');
                    return header + sections;
                } catch (_) {
                    return 'Áï∞Â∏∏„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂÖ¨Êºî„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇË©≥Á¥∞Ë°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„Åå„ÄÅ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ';
                }
            }

            updateDashboard() {
                if (!this.currentData) return;

                this.updateStatusIndicators();
                this.updateStatistics();
                this.updateTimeslotsGrid();
                // URLÊÉÖÂ†±„ÇÇÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞
                this.refreshUrlInfo(false);
            }

            async refreshUrlInfo(force = true) {
                try {
                    // „Åü„Å≥„Åü„Å≥Âëº„Å∞„Çå„Çã„Åü„ÇÅ„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇUI„ÅØÂ£ä„Åï„Å™„ÅÑ
                    const info = await GasAPI.getUrlManagerInfo();
                    if (!info || !this.elements.apiUrlLabel || !this.elements.apiUrlMeta) return;
                    this.elements.apiUrlLabel.textContent = info.url || '(‰∏çÊòé)';
                    this.elements.apiUrlMeta.textContent = `(${info.index || '?'} / ${info.total || '?'}) ÊúÄÁµÇ„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥: ${info.lastRotation || '-'}`;
                    if (force) {
                        this.showSuccess('GASÊé•Á∂öÂÖàÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    }
                } catch (_) {
                    // noop
                }
            }

            startUrlAutoRotation() {
                try {
                    if (this.urlRotationInterval) return;
                    const ROTATE_MS = 10 * 60 * 1000; // 10ÂàÜ
                    this.urlRotationInterval = setInterval(async () => {
                        try {
                            await GasAPI.selectRandomUrl();
                            await this.refreshUrlInfo(false);
                        } catch (_) { }
                    }, ROTATE_MS);
                } catch (_) { }
            }

            notifyNewClasses(data) {
                try {
                    const timeslots = (data && Array.isArray(data.timeslots)) ? data.timeslots : [];
                    let groups = Array.from(new Set(timeslots.map(t => t && t.group).filter(Boolean)));
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Ëøë„ÅÆ„Éû„ÉÉ„Éó„Åã„ÇâÊäΩÂá∫
                    if (groups.length === 0 && this.latestTimeslotMap && this.latestTimeslotMap.size > 0) {
                        groups = Array.from(new Set(Array.from(this.latestTimeslotMap.values()).map(t => t && t.group).filter(Boolean)));
                    }
                    if (groups.length > 0) {
                        groups.forEach(g => console.log(`[Class Arrival] Âèó‰ø°: ${g}`));
                    } else {
                        // „Éá„Éº„Çø„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÈùô„Åã„Å´„Çπ„Ç≠„ÉÉ„Éó
                    }
                } catch (_) {
                    // noop
                }
            }

            updateStatusIndicators() {
                const summary = this.currentData.summary;

                document.getElementById('full-count').textContent = summary.fullCapacity;
                document.getElementById('critical-count').textContent = summary.criticalCapacity;
                document.getElementById('warning-count').textContent = summary.warningCapacity;
                document.getElementById('normal-count').textContent = summary.normalCapacity;
            }

            updateStatistics() {
                const stats = enhancedStatusMonitor.getStatistics();

                document.getElementById('total-checks').textContent = stats.totalChecks;
                document.getElementById('total-notifications').textContent = stats.totalNotifications;
                document.getElementById('average-empty').textContent = stats.averageEmptySeats.toFixed(1);

                if (stats.lastCheckTime) {
                    const time = new Date(stats.lastCheckTime).toLocaleTimeString('ja-JP', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('last-check-time').textContent = time;
                }
            }

            updateTimeslotsGrid() {
                const timeslots = Array.from(this.latestTimeslotMap.values());
                if (!Array.isArray(timeslots) || timeslots.length === 0) {
                    // ÂàùÂõû„ÅÆ„ÅøÁ©∫Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
                    const existingGrid = this.elements.timeslotsContainer.querySelector('#timeslots-grid');
                    if (!existingGrid) {
                        this.elements.timeslotsContainer.innerHTML = '<div class="loading">ÂÖ¨Êºî„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    }
                    return;
                }

                // „Ç∞„É™„ÉÉ„ÉâË¶ÅÁ¥†„ÇíÁ¢∫‰øùÔºàÁÑ°„Åë„Çå„Å∞‰∏ÄÂ∫¶„Å†„Åë‰ΩúÊàêÔºâ
                let gridEl = this.elements.timeslotsContainer.querySelector('#timeslots-grid');
                if (!gridEl) {
                    this.elements.timeslotsContainer.innerHTML = '';
                    gridEl = document.createElement('div');
                    gridEl.className = 'timeslots-grid';
                    gridEl.id = 'timeslots-grid';
                    this.elements.timeslotsContainer.appendChild(gridEl);
                }

                const desiredIds = new Set();
                for (const t of timeslots) {
                    const id = this.getTimeslotId(t);
                    desiredIds.add(id);
                    let card = gridEl.querySelector(`[data-id="${CSS.escape(id)}"]`);
                    if (card) {
                        this.updateTimeslotCard(card, t);
                    } else {
                        card = this.createTimeslotCardElement(t, id);
                        gridEl.appendChild(card);
                    }
                }

                // Â∏∏ÊôÇË°®Á§∫: ‰ΩôÂàÜ„Å™„Ç´„Éº„Éâ„ÅØÁ∂≠ÊåÅÔºàÈùûÊõ¥Êñ∞„ÅÆ„Ç´„Éº„Éâ„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
            }

            getTimeslotsByLevel(level) {
                try {
                    const all = Array.from(this.latestTimeslotMap.values());
                    return all.filter(t => (t.capacityLevel || 'normal') === level);
                } catch (_) { return []; }
            }

            showStatusListModal(level) {
                try {
                    const list = this.getTimeslotsByLevel(level);
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:10000;display:flex;align-items:center;justify-content:center;padding:16px;';
                    const modal = document.createElement('div');
                    modal.style.cssText = 'background:#fff;border-radius:12px;max-width:720px;width:100%;max-height:80vh;overflow:auto;box-shadow:0 12px 32px rgba(0,0,0,.25);';
                    const header = document.createElement('div');
                    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;background:#667eea;color:#fff;padding:14px 16px;font-weight:600;';
                    header.textContent = `„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄË¶ßÔºö${this.getCapacityLevelText(level)} (${list.length}‰ª∂)`;
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'Èñâ„Åò„Çã';
                    closeBtn.style.cssText = 'margin-left:12px;background:rgba(255,255,255,.2);color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer;';
                    closeBtn.addEventListener('click', () => overlay.remove());
                    header.appendChild(closeBtn);
                    const body = document.createElement('div');
                    body.style.cssText = 'padding:16px;';

                    if (list.length === 0) {
                        body.innerHTML = '<p style="color:#666;text-align:center;padding:24px;">Ë©≤ÂΩì„Åô„ÇãÂÖ¨Êºî„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    } else {
                        const items = list
                            .sort((a, b) => String(a.group).localeCompare(String(b.group)) || String(a.day).localeCompare(String(b.day)) || String(a.timeslot).localeCompare(String(b.timeslot)))
                            .map(t => {
                                const remain = `${Number.isFinite(t.emptySeats) ? t.emptySeats : 0}/${Number.isFinite(t.totalSeats) ? t.totalSeats : 0}`;
                                const last = t.lastChecked ? new Date(t.lastChecked).toLocaleString('ja-JP') : '-';
                                return `<div style="border:1px solid #e1e5e9;border-left:4px solid;${this.statusBorderColor(level)};border-radius:8px;padding:12px;margin:8px 0;background:#f8f9fa;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div style="font-weight:600;">${t.group} ${String(t.day)}Êó•ÁõÆ ${t.timeslot}</div>
                                    <span style="font-size:12px;color:#666;">${last}</span>
                                </div>
                                <div style="margin-top:8px;color:#333;">ÁèæÂú®„ÅÆÁä∂Ê≥ÅÔºö${this.getCapacityLevelText(level)}</div>
                                <div style="margin-top:4px;color:#333;">ÊÆã„ÇäÔºö${remain} Â∏≠</div>
                            </div>`;
                            }).join('');
                        body.innerHTML = items;
                    }

                    modal.appendChild(header);
                    modal.appendChild(body);
                    overlay.appendChild(modal);
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
                    document.body.appendChild(overlay);
                } catch (e) {
                    console.warn('showStatusListModal failed:', e);
                }
            }

            statusBorderColor(level) {
                switch (level) {
                    case 'full': return 'border-left-color:#e74c3c;';
                    case 'critical': return 'border-left-color:#f39c12;';
                    case 'warning': return 'border-left-color:#f1c40f;';
                    default: return 'border-left-color:#27ae60;';
                }
            }

            getTimeslotId(timeslot) {
                const group = timeslot.group || '‰∏çÊòé';
                const day = String(timeslot.day || '');
                const slot = timeslot.timeslot || '';
                return `${group}|${day}|${slot}`;
            }

            createTimeslotCardElement(timeslot, id) {
                const el = document.createElement('div');
                el.className = 'timeslot-card';
                el.setAttribute('data-id', id);
                el.style.cursor = 'pointer';
                el.innerHTML = `
                        <div class="timeslot-header">
                        <h4 class="timeslot-title"></h4>
                        <span class="capacity-badge"></span>
                        </div>
                        <div class="timeslot-stats">
                            <div class="stat-item">
                            <p class="stat-value" data-field="emptySeats"></p>
                                <p class="stat-label">Á©∫Â∏≠</p>
                            </div>
                            <div class="stat-item">
                            <p class="stat-value" data-field="occupiedSeats"></p>
                                <p class="stat-label">Âà©Áî®‰∏≠</p>
                            </div>
                        </div>
                        <div class="timeslot-progress">
                        <div class="progress-bar"></div>
                        </div>
                    <p class="last-updated"></p>
                    <p class="click-hint" style="font-size: 12px; color: #667eea; text-align: center; margin: 8px 0 0 0; font-weight: 500;">„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞Ë°®Á§∫</p>
                `;

                // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
                el.addEventListener('click', () => {
                    this.showPerformanceDetailsModal(timeslot);
                });

                this.updateTimeslotCard(el, timeslot);
                return el;
            }

            updateTimeslotCard(cardEl, timeslot) {
                const capacityLevel = timeslot.capacityLevel || 'normal';
                const occupancyRate = timeslot.totalSeats > 0 ? (timeslot.occupiedSeats / timeslot.totalSeats) * 100 : 0;
                // „Çπ„ÉÜ„Éº„É´Âà§ÂÆöÔºàÊõ¥Êñ∞„ÅåÈÅÖ„Çå„Å¶„ÅÑ„Çã„Ç´„Éº„Éâ„ÇíË¶ñË¶öÂåñ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ 'stale' „ÇØ„É©„Çπ„Çí‰ªò‰∏éÔºâ
                let isStale = false;
                try {
                    const last = new Date(timeslot.lastChecked).getTime();
                    const intervalMs = (parseInt(this.elements.checkInterval.value) || 15) * 1000;
                    if (Date.now() - last > intervalMs * 2) isStale = true;
                } catch (_) { }
                cardEl.className = `timeslot-card ${capacityLevel}${isStale ? ' stale' : ''}`;

                const titleEl = cardEl.querySelector('.timeslot-title');
                if (titleEl) titleEl.textContent = `${timeslot.group} ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot}`;

                const badgeEl = cardEl.querySelector('.capacity-badge');
                if (badgeEl) {
                    badgeEl.className = `capacity-badge ${capacityLevel}`;
                    badgeEl.textContent = this.getCapacityLevelText(capacityLevel);
                }

                const emptyEl = cardEl.querySelector('[data-field="emptySeats"]');
                if (emptyEl) emptyEl.textContent = timeslot.emptySeats;
                const occEl = cardEl.querySelector('[data-field="occupiedSeats"]');
                if (occEl) occEl.textContent = timeslot.occupiedSeats;

                const barEl = cardEl.querySelector('.progress-bar');
                if (barEl) {
                    barEl.className = `progress-bar ${capacityLevel}`;
                    barEl.style.width = `${occupancyRate}%`;
                }

                const timeEl = cardEl.querySelector('.last-updated');
                if (timeEl) timeEl.textContent = new Date(timeslot.lastChecked).toLocaleString('ja-JP');
            }

            getCapacityLevelText(level) {
                const texts = {
                    full: 'Ê∫ÄÂ∏≠',
                    critical: 'Á∑äÊÄ•',
                    warning: 'Ë≠¶Âëä',
                    normal: 'Ê≠£Â∏∏'
                };
                return texts[level] || '‰∏çÊòé';
            }

            updateNotificationHistory() {
                if (this.notificationHistory.length === 0) {
                    this.elements.notificationList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ÈÄöÁü•Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }

                const history = this.notificationHistory.map(notification => `
                    <div class="notification-item ${notification.priority}">
                        <p class="notification-text">${notification.message}</p>
                        <p class="notification-time">${new Date(notification.timestamp).toLocaleString('ja-JP')}</p>
                    </div>
                `).join('');

                this.elements.notificationList.innerHTML = history;
            }

            showLoading() {
                this.elements.timeslotsContainer.innerHTML = '<div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
            }

            showError(message) {
                this.elements.errorMessage.textContent = message;
                this.elements.errorContainer.style.display = 'block';
                this.elements.successContainer.style.display = 'none';

                setTimeout(() => {
                    this.elements.errorContainer.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                this.elements.successMessage.textContent = message;
                this.elements.successContainer.style.display = 'block';
                this.elements.errorContainer.style.display = 'none';

                setTimeout(() => {
                    this.elements.successContainer.style.display = 'none';
                }, 3000);
            }

            async showPerformanceDetailsModal(timeslot) {
                try {
                    // „É¢„Éº„ÉÄ„É´„Ç™„Éº„Éê„Éº„É¨„Ç§„Çí‰ΩúÊàê
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';

                    // „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
                    const modal = document.createElement('div');
                    modal.className = 'modal-content';

                    // „Éò„ÉÉ„ÉÄ„Éº
                    const header = document.createElement('div');
                    header.className = 'modal-header';
                    header.innerHTML = `
                        <h2 class="modal-title">${timeslot.group} ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot} - Ë©≥Á¥∞„Éá„Éº„Çø</h2>
                        <button class="modal-close">&times;</button>
                    `;

                    // „Éú„Éá„Ç£Ôºà„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÔºâ
                    const body = document.createElement('div');
                    body.className = 'modal-body';
                    body.innerHTML = '<div class="loading-modal">Ë©≥Á¥∞„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';

                    modal.appendChild(header);
                    modal.appendChild(body);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);

                    // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
                    const closeBtn = header.querySelector('.modal-close');
                    const closeModal = () => {
                        overlay.remove();
                    };
                    closeBtn.addEventListener('click', closeModal);
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) closeModal();
                    });

                    // Ë©≥Á¥∞„Éá„Éº„Çø„ÇíÂèñÂæó
                    try {
                        const detailedData = await this.getDetailedSeatData(timeslot);
                        this.renderPerformanceDetails(body, timeslot, detailedData);
                    } catch (error) {
                        body.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                                <h3>„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº</h3>
                                <p>Ë©≥Á¥∞„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</p>
                                <button onclick="this.closest('.modal-overlay').remove()" 
                                        style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Èñâ„Åò„Çã
                                </button>
                            </div>
                        `;
                    }

                } catch (error) {
                    console.error('Modal creation failed:', error);
                    this.showError('„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            async getDetailedSeatData(timeslot, retryCount = 0) {
                const maxRetries = 2;

                try {
                    console.log(`Fetching detailed seat data for: ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot} (attempt ${retryCount + 1})`);

                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„ÅßAPIÂëº„Å≥Âá∫„ÅóÔºà„ÇØ„É©„ÇπÂàÜÊûêÁî®„Å´Âª∂Èï∑Ôºâ
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('APIÂëº„Å≥Âá∫„Åó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü')), 8000);
                    });

                    const apiPromise = GasAPI.getSeatData(timeslot.group, timeslot.day, timeslot.timeslot, true, true);
                    const response = await Promise.race([apiPromise, timeoutPromise]);

                    console.log('API response:', response);

                    if (!response || !response.success) {
                        throw new Error(response?.message || response?.error || '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }

                    // seatMapÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÇíÈÖçÂàóÂΩ¢Âºè„Å´Â§âÊèõ
                    let seatData = null;
                    if (response.seatMap && typeof response.seatMap === 'object') {
                        console.log('Converting seatMap to array format');
                        console.log('seatMap keys:', Object.keys(response.seatMap));
                        console.log('First seat example:', Object.entries(response.seatMap)[0]);
                        seatData = this.convertSeatMapToArray(response.seatMap);
                    } else if (response.data && Array.isArray(response.data)) {
                        seatData = response.data;
                    } else {
                        throw new Error('Â∫ßÂ∏≠„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                    }

                    if (!seatData || seatData.length === 0) {
                        throw new Error('Â∫ßÂ∏≠„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô');
                    }

                    console.log('Converted seat data:', seatData);
                    return seatData;
                } catch (error) {
                    console.error(`Detailed seat data fetch failed (attempt ${retryCount + 1}):`, error);

                    // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™Â†¥Âêà
                    if (retryCount < maxRetries) {
                        console.log(`Retrying in 1 second... (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return this.getDetailedSeatData(timeslot, retryCount + 1);
                    }

                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Åã„ÇâË®àÁÆó„ÇíË©¶Ë°å
                    if (timeslot && timeslot.totalSeats > 0) {
                        console.log('Using fallback calculation with timeslot data');
                        return this.createFallbackSeatData(timeslot);
                    }

                    throw new Error(`Â∫ßÂ∏≠„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            convertSeatMapToArray(seatMap) {
                const seatArray = [];

                console.log('Converting seatMap:', seatMap);

                for (const [seatId, seatInfo] of Object.entries(seatMap)) {
                    if (seatInfo && typeof seatInfo === 'object') {
                        console.log(`Processing seat ${seatId}:`, seatInfo);

                        // seatInfo„Åã„ÇâÂ∫ßÂ∏≠„Éá„Éº„Çø„ÇíÊäΩÂá∫ÔºàË§áÊï∞„ÅÆÂèØËÉΩÊÄß„ÇíË©¶Ë°åÔºâ
                        const rowLabel = seatInfo.row || seatInfo.rowLabel || seatId.charAt(0);
                        const colLabel = seatInfo.col || seatInfo.colLabel || seatId.substring(1);

                        // „Çπ„ÉÜ„Éº„Çø„ÇπÂÄ§„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàËã±Ë™û‚ÜíÊó•Êú¨Ë™ûÔºâ
                        let statusC = seatInfo.statusC || seatInfo.status || seatInfo.c || '';
                        let statusE = seatInfo.statusE || seatInfo.checkIn || seatInfo.e || '';

                        // Ëã±Ë™û„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂÄ§„ÇíÊó•Êú¨Ë™û„Å´Â§âÊèõ
                        if (statusC === 'checked-in') {
                            statusC = '‰∫àÁ¥ÑÊ∏à';
                            statusE = 'Ê∏à';
                        } else if (statusC === 'to-be-checked-in') {
                            statusC = '‰∫àÁ¥ÑÊ∏à';
                            statusE = '';
                        } else if (statusC === 'reserved') {
                            statusC = 'Á¢∫‰øù';
                            statusE = '';
                        } else if (statusC === 'empty' || statusC === 'available') {
                            statusC = 'Á©∫';
                            statusE = '';
                        }

                        const nameD = seatInfo.nameD || seatInfo.name || seatInfo.d || '';

                        console.log(`Converted ${seatId}: C="${statusC}", E="${statusE}"`);
                        seatArray.push([rowLabel, colLabel, statusC, nameD, statusE]);
                    }
                }

                console.log(`Converted ${seatArray.length} seats from seatMap`);
                console.log('Sample converted data:', seatArray.slice(0, 5));
                return seatArray;
            }

            createFallbackSeatData(timeslot) {
                // Êó¢Â≠ò„ÅÆtimeslot„Éá„Éº„Çø„Åã„ÇâÊé®ÂÆö„Éá„Éº„Çø„Çí‰ΩúÊàê
                const totalSeats = timeslot.totalSeats || 0;
                const occupiedSeats = timeslot.occupiedSeats || 0;
                const emptySeats = timeslot.emptySeats || 0;

                // ‰øÆÊ≠£„Åï„Çå„ÅüÊé®ÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºàÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                const estimatedCheckedIn = Math.floor(occupiedSeats * 0.4); // 40%„Åå„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„Åø„Å®‰ªÆÂÆö
                const estimatedReservedWithoutCheckIn = occupiedSeats - estimatedCheckedIn; // ÊÆã„Çä„ÅåÊú™„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥

                const fallbackData = [];

                // ‰∫àÁ¥ÑÊ∏à„ÅøÊú™„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Â∫ßÂ∏≠ÔºàCÂàó„Åå‰∫àÁ¥ÑÊ∏à„Åã„Å§EÂàó„ÅåÁ©∫Ôºâ
                const reservedWithoutCheckIn = Math.floor(estimatedReservedWithoutCheckIn * 0.7);
                for (let i = 0; i < reservedWithoutCheckIn; i++) {
                    fallbackData.push(['A', i + 1, '‰∫àÁ¥ÑÊ∏à', 'È°ßÂÆ¢Âêç', '']);
                }

                // Á¢∫‰øùÂ∫ßÂ∏≠ÔºàCÂàó„ÅåÁ¢∫‰øù„ÄÅEÂàó„ÅÆÂÜÖÂÆπ„ÅØÈñ¢‰øÇ„Å™„ÅóÔºâ
                const securedSeats = estimatedReservedWithoutCheckIn - reservedWithoutCheckIn;
                for (let i = 0; i < securedSeats; i++) {
                    fallbackData.push(['B', i + 1, 'Á¢∫‰øù', 'È°ßÂÆ¢Âêç', '']);
                }

                // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠ÔºàCÂàó„Åå‰∫àÁ¥ÑÊ∏à„Åã„Å§EÂàó„ÅåÊ∏àÔºâ
                for (let i = 0; i < estimatedCheckedIn; i++) {
                    fallbackData.push(['C', i + 1, '‰∫àÁ¥ÑÊ∏à', 'È°ßÂÆ¢Âêç', 'Ê∏à']);
                }

                // Á©∫Â∏≠
                for (let i = 0; i < emptySeats; i++) {
                    fallbackData.push(['D', i + 1, 'Á©∫', '', '']);
                }

                console.log('Created fallback data:', fallbackData.length, 'seats');
                console.log('Fallback breakdown:', {
                    reservedWithoutCheckIn: reservedWithoutCheckIn,
                    secured: securedSeats,
                    checkedIn: estimatedCheckedIn,
                    empty: emptySeats,
                    total: reservedWithoutCheckIn + securedSeats + estimatedCheckedIn + emptySeats
                });
                return fallbackData;
            }

            renderPerformanceDetails(body, timeslot, detailedData) {
                // Â∫ßÂ∏≠„Éá„Éº„Çø„ÇíÂàÜÊûê
                const analysis = this.analyzeSeatData(detailedData);

                // „Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                const dataConsistency = this.checkDataConsistency(timeslot, analysis);

                body.innerHTML = `
                    <div class="performance-details">
                        <div class="detail-card reserved">
                            <h4>‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠</h4>
                            <div class="detail-stats">
                                <div class="stat-box">
                                    <p class="stat-value">${analysis.reservedSeats}</p>
                                    <p class="stat-label">Â∫ßÂ∏≠Êï∞</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysis.reservedSeatsRate}%</p>
                                    <p class="stat-label">Á∑èÂ∫ßÂ∏≠Êï∞„Å´ÂØæ„Åô„ÇãÂâ≤Âêà</p>
                                </div>
                            </div>
                            <div class="occupancy-rate">
                                Á∑èÂ∫ßÂ∏≠Êï∞: ${analysis.totalSeats || timeslot.totalSeats}Â∏≠
                            </div>
                        </div>
                        
                        <div class="detail-card checked-in">
                            <h4>„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠</h4>
                            <div class="detail-stats">
                                <div class="stat-box">
                                    <p class="stat-value">${analysis.checkedInSeats}</p>
                                    <p class="stat-label">Â∫ßÂ∏≠Êï∞</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysis.checkedInRate}%</p>
                                    <p class="stat-label">‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„Å´ÂØæ„Åô„ÇãÂâ≤Âêà</p>
                                </div>
                            </div>
                            <div class="occupancy-rate">
                                ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞: ${analysis.reservedSeats}Â∏≠
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">ÂÖ®‰Ωì„Çµ„Éû„É™„Éº</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <p style="font-size: 24px; font-weight: 700; margin: 0; color: #333;">${analysis.totalSeats || timeslot.totalSeats}</p>
                                <p style="font-size: 14px; color: #666; margin: 0;">Á∑èÂ∫ßÂ∏≠Êï∞</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 24px; font-weight: 700; margin: 0; color: #667eea;">${analysis.reservedSeats}</p>
                                <p style="font-size: 14px; color: #666; margin: 0;">‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 24px; font-weight: 700; margin: 0; color: #27ae60;">${analysis.checkedInSeats}</p>
                                <p style="font-size: 14px; color: #666; margin: 0;">„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-size: 24px; font-weight: 700; margin: 0; color: #e74c3c;">${analysis.emptySeats || timeslot.emptySeats}</p>
                                <p style="font-size: 14px; color: #666; margin: 0;">Á©∫Â∏≠Êï∞</p>
                            </div>
                        </div>
                    </div>
                    
                    ${dataConsistency.warnings.length > 0 ? `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÅÆË≠¶Âëä</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #856404;">
                            ${dataConsistency.warnings.map(warning => `<li>${warning}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${analysis.validationErrors ? `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #721c24;">‚ùå „Éá„Éº„ÇøÊ§úË®º„Ç®„É©„Éº</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #721c24; font-size: 12px;">
                            ${analysis.validationErrors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #004085;">‚ÑπÔ∏è „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊÉÖÂ†±</h4>
                        <p style="margin: 0; color: #004085; font-size: 14px;">
                            „Éá„Éº„ÇøÂèñÂæóÊôÇÂàª: ${new Date().toLocaleString('ja-JP')}<br>
                            ÂàÜÊûêÂØæË±°Â∫ßÂ∏≠Êï∞: ${detailedData ? detailedData.length : 0}Â∏≠<br>
                            „Éá„Éº„Çø„ÇΩ„Éº„Çπ: ${detailedData ? 'API (seatMapÂ§âÊèõ)' : '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ'}<br>
                            ÂàÜÊûêÁµêÊûúË©≥Á¥∞: ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠=${analysis.reservedSeats}Â∏≠, „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„Åø=${analysis.checkedInSeats}Â∏≠, Á©∫Â∏≠=${analysis.emptySeats}Â∏≠<br>
                            Âá¶ÁêÜÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞: ${analysis.processedSeats || analysis.totalSeats}Â∏≠ / Á∑èÂ∫ßÂ∏≠Êï∞: ${analysis.totalSeats}Â∏≠<br>
                            „Éá„Éº„ÇøÊï¥ÂêàÊÄß: ${analysis.validationErrors ? '„Ç®„É©„Éº„ÅÇ„Çä' : 'Ê≠£Â∏∏'}
                        </p>
                    </div>
                `;
            }

            checkDataConsistency(timeslot, analysis) {
                const warnings = [];

                console.log('Data consistency check:', {
                    dashboard: {
                        totalSeats: timeslot.totalSeats,
                        emptySeats: timeslot.emptySeats,
                        occupiedSeats: timeslot.totalSeats - timeslot.emptySeats
                    },
                    analysis: {
                        totalSeats: analysis.totalSeats,
                        emptySeats: analysis.emptySeats,
                        processedSeats: analysis.processedSeats,
                        reservedSeats: analysis.reservedSeats,
                        checkedInSeats: analysis.checkedInSeats
                    }
                });

                // Á∑èÂ∫ßÂ∏≠Êï∞„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅÆÁ∑èÂ∫ßÂ∏≠Êï∞„Å®ÂàÜÊûê„ÅÆÁ∑èÂ∫ßÂ∏≠Êï∞„ÇíÊØîËºÉÔºâ
                if (timeslot.totalSeats !== analysis.totalSeats) {
                    warnings.push(`Á∑èÂ∫ßÂ∏≠Êï∞„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ=${timeslot.totalSeats}, Ë©≥Á¥∞ÂàÜÊûê=${analysis.totalSeats}`);
                }

                // Á©∫Â∏≠Êï∞„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (timeslot.emptySeats !== analysis.emptySeats) {
                    warnings.push(`Á©∫Â∏≠Êï∞„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ=${timeslot.emptySeats}, Ë©≥Á¥∞ÂàÜÊûê=${analysis.emptySeats}`);
                }

                // ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅÆÂç†ÊúâÂ∏≠Êï∞„Å®ÂàÜÊûê„ÅÆ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÇíÊØîËºÉÔºâ
                const dashboardOccupied = timeslot.totalSeats - timeslot.emptySeats;
                if (dashboardOccupied !== analysis.reservedSeats) {
                    warnings.push(`‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ=${dashboardOccupied}, Ë©≥Á¥∞ÂàÜÊûê=${analysis.reservedSeats}`);
                }

                // Âá¶ÁêÜÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                if (analysis.processedSeats !== analysis.totalSeats) {
                    warnings.push(`Âá¶ÁêÜÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÅåÁ∑èÂ∫ßÂ∏≠Êï∞„Å®‰∏ÄËá¥„Åó„Åæ„Åõ„Çì: Âá¶ÁêÜÊ∏à„Åø=${analysis.processedSeats}, Á∑èÊï∞=${analysis.totalSeats}`);
                }

                // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (analysis.checkedInSeats > analysis.reservedSeats) {
                    warnings.push(`„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞„Åå‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô: „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥=${analysis.checkedInSeats}, ‰∫àÁ¥ÑÊ∏à„Åø=${analysis.reservedSeats}`);
                }

                return { warnings };
            }

            analyzeSeatData(seatData) {
                console.log('Analyzing seat data:', seatData);

                if (!seatData || !Array.isArray(seatData)) {
                    console.warn('Invalid seat data provided');
                    return {
                        reservedSeats: 0,
                        checkedInSeats: 0,
                        reservedSeatsRate: 0,
                        checkedInRate: 0,
                        totalSeats: 0,
                        emptySeats: 0,
                        validationErrors: ['„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô']
                    };
                }

                let reservedSeats = 0; // CÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åæ„Åü„ÅØ„ÄåÁ¢∫‰øù„Äç„ÅÆÂ∫ßÂ∏≠Êï∞ÔºàEÂàó„ÅØÈñ¢‰øÇ„Å™„ÅóÔºâ
                let checkedInSeats = 0; // CÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åã„Å§EÂàó„Åå„ÄåÊ∏à„Äç„ÅÆÂ∫ßÂ∏≠Êï∞
                let totalSeats = 0;
                let emptySeats = 0;
                let validationErrors = [];
                let processedSeats = 0;

                seatData.forEach((seat, index) => {
                    try {
                        // „Åæ„ÅöÂ∫ßÂ∏≠„Çí„Ç´„Ç¶„É≥„ÉàÔºàÁÑ°Âäπ„Å™„Éá„Éº„Çø„Åß„ÇÇ„Ç´„Ç¶„É≥„ÉàÔºâ
                        totalSeats++;

                        if (!seat || !Array.isArray(seat)) {
                            validationErrors.push(`Ë°å${index + 1}: ÁÑ°Âäπ„Å™Â∫ßÂ∏≠„Éá„Éº„Çø`);
                            return;
                        }

                        if (seat.length < 5) {
                            validationErrors.push(`Ë°å${index + 1}: „Éá„Éº„ÇøÂàóÊï∞‰∏çË∂≥ (${seat.length}Âàó)`);
                            return;
                        }

                        const rowLabel = (seat[0] || '').toString().trim();
                        const colLabel = (seat[1] || '').toString().trim();
                        const statusC = (seat[2] || '').toString().trim();
                        const nameD = (seat[3] || '').toString().trim();
                        const statusE = (seat[4] || '').toString().trim();

                        // ÊúâÂäπ„Å™Â∫ßÂ∏≠ID„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        if (!rowLabel || !colLabel) {
                            validationErrors.push(`Ë°å${index + 1}: ÁÑ°Âäπ„Å™Â∫ßÂ∏≠ID (Ë°å: "${rowLabel}", Âàó: "${colLabel}")`);
                            return;
                        }

                        processedSeats++;

                        // ‰øÆÊ≠£„Åï„Çå„ÅüÂàÜÊûê„É≠„Ç∏„ÉÉ„ÇØÔºàË¶ÅÊ±Ç‰ªïÊßò„Å´Ê∫ñÊã†Ôºâ
                        // 1. ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠: CÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åæ„Åü„ÅØ„ÄåÁ¢∫‰øù„Äç„ÅÆÂ∫ßÂ∏≠Êï∞ÔºàEÂàó„ÅØÈñ¢‰øÇ„Å™„ÅóÔºâ
                        // 2. „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠: CÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åã„Å§EÂàó„Åå„ÄåÊ∏à„Äç„ÅÆÂ∫ßÂ∏≠Êï∞
                        // 3. ÂàÜÊØç: ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„ÅÆË®àÁÆó„ÅØÁ∑èÂ∫ßÂ∏≠Êï∞„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠„ÅÆË®àÁÆó„ÅØ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞

                        if (statusC === '‰∫àÁ¥ÑÊ∏à' || statusC === 'Á¢∫‰øù' ||
                            statusC === 'checked-in' || statusC === 'to-be-checked-in' || statusC === 'reserved') {
                            // ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„Å®„Åó„Å¶„Ç´„Ç¶„É≥„ÉàÔºàEÂàó„ÅØÈñ¢‰øÇ„Å™„ÅóÔºâ
                            reservedSeats++;

                            // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„Åø„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
                            if ((statusC === '‰∫àÁ¥ÑÊ∏à' && statusE === 'Ê∏à') || statusC === 'checked-in') {
                                checkedInSeats++;
                            }
                        } else if (statusC === 'Á©∫' || statusC === '' || statusC === 'empty' || statusC === 'available') {
                            emptySeats++;
                        } else {
                            // CÂàó„ÅåË™çË≠ò„Åß„Åç„Å™„ÅÑÂÄ§„ÅÆÂ†¥Âêà
                            validationErrors.push(`Ë°å${index + 1}: ‰∏çÊòé„Å™CÂàó„ÅÆÂÄ§ "${statusC}"`);
                            // ‰∏çÊòé„Å™ÂÄ§„ÅÆÂ†¥Âêà„ÅØÁ©∫Â∏≠„Å®„Åó„Å¶Êâ±„ÅÜ
                            emptySeats++;
                        }
                    } catch (error) {
                        validationErrors.push(`Ë°å${index + 1}: Âá¶ÁêÜ„Ç®„É©„Éº - ${error.message}`);
                    }
                });

                // Ë®àÁÆóÁµêÊûú„ÅÆÊ§úË®º
                const calculatedTotal = reservedSeats + emptySeats;
                if (calculatedTotal !== processedSeats) {
                    validationErrors.push(`Â∫ßÂ∏≠Êï∞‰∏ç‰∏ÄËá¥: Ë®àÁÆóÂÄ§=${calculatedTotal}, Âá¶ÁêÜÊ∏à„Åø=${processedSeats}`);
                }

                // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                if (checkedInSeats > reservedSeats) {
                    validationErrors.push(`„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞„Åå‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô: „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥=${checkedInSeats}, ‰∫àÁ¥ÑÊ∏à„Åø=${reservedSeats}`);
                }

                // Ê≠£„Åó„ÅÑË®àÁÆóÊñπÊ≥ï
                const reservedSeatsRate = totalSeats > 0 ? (reservedSeats / totalSeats) * 100 : 0; // Á∑èÂ∫ßÂ∏≠Êï∞„Å´ÂØæ„Åô„Çã‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„ÅÆÂâ≤Âêà
                const checkedInRate = reservedSeats > 0 ? (checkedInSeats / reservedSeats) * 100 : 0; // ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„Å´ÂØæ„Åô„Çã„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠„ÅÆÂâ≤Âêà

                const result = {
                    reservedSeats, // ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠Êï∞ÔºàCÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åæ„Åü„ÅØ„ÄåÁ¢∫‰øù„ÄçÔºâ
                    checkedInSeats, // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠Êï∞ÔºàCÂàó„Åå„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åã„Å§EÂàó„Åå„ÄåÊ∏à„ÄçÔºâ
                    reservedSeatsRate: Math.round(reservedSeatsRate * 10) / 10, // Á∑èÂ∫ßÂ∏≠Êï∞„Å´ÂØæ„Åô„Çã‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„ÅÆÂâ≤Âêà
                    checkedInRate: Math.round(checkedInRate * 10) / 10, // ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„Å´ÂØæ„Åô„Çã„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„ÅøÂ∫ßÂ∏≠„ÅÆÂâ≤Âêà
                    totalSeats,
                    emptySeats,
                    processedSeats,
                    validationErrors: validationErrors.length > 0 ? validationErrors : null
                };

                console.log('Analysis result:', result);
                console.log('Breakdown:', {
                    totalSeats,
                    processedSeats,
                    reservedSeats,
                    checkedInSeats,
                    emptySeats,
                    reservedSeatsRate: `${reservedSeats}/${totalSeats} = ${reservedSeatsRate.toFixed(1)}%`,
                    checkedInRate: `${checkedInSeats}/${reservedSeats} = ${checkedInRate.toFixed(1)}%`
                });
                return result;
            }

            // „ÇØ„É©„ÇπÂà•ÂàÜÊûê„ÅÆÂàùÊúüÂåñ
            async initializeClassAnalysis() {
                try {
                    if (!this.elements.classButtonsContainer) {
                        console.warn('Class buttons container not found');
                        return;
                    }

                    // Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Åã„Çâ„ÇØ„É©„Çπ‰∏ÄË¶ß„ÇíÂèñÂæó
                    const classes = this.extractClassesFromData();
                    if (classes.length === 0) {
                        this.elements.classButtonsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">„ÇØ„É©„ÇπÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>';
                        return;
                    }

                    this.renderClassButtons(classes);
                } catch (error) {
                    console.error('Class analysis initialization failed:', error);
                    if (this.elements.classButtonsContainer) {
                        this.elements.classButtonsContainer.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">„ÇØ„É©„ÇπÂàÜÊûê„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
                    }
                }
            }

            // „Éá„Éº„Çø„Åã„Çâ„ÇØ„É©„Çπ‰∏ÄË¶ß„ÇíÊäΩÂá∫
            extractClassesFromData() {
                const classes = new Set();

                // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åã„Çâ„ÇØ„É©„Çπ„ÇíÊäΩÂá∫
                if (this.currentData && this.currentData.timeslots) {
                    this.currentData.timeslots.forEach(timeslot => {
                        if (timeslot.group) {
                            classes.add(timeslot.group);
                        }
                    });
                }

                // Êó¢Â≠ò„ÅÆtimeslotMap„Åã„Çâ„ÇÇÊäΩÂá∫
                this.latestTimeslotMap.forEach(timeslot => {
                    if (timeslot.group) {
                        classes.add(timeslot.group);
                    }
                });

                return Array.from(classes).sort();
            }

            // „ÇØ„É©„Çπ„Éú„Çø„É≥„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderClassButtons(classes) {
                const buttonsHtml = classes.map(group => {
                    const classData = this.getClassSummary(group);
                    return `
                        <button class="class-button" data-group="${group}" onclick="window.MonitoringDashboard.showClassAnalysis('${group}')">
                            <span class="class-name">${group}ÁµÑ</span>
                            <span class="class-stats">ÂÖ¨ÊºîÊï∞: ${classData.totalPerformances}‰ª∂</span>
                            <span class="class-description">Á∑èÂ∫ßÂ∏≠: ${classData.totalSeats}Â∏≠ | Á©∫Â∏≠: ${classData.totalEmptySeats}Â∏≠</span>
                        </button>
                    `;
                }).join('');

                this.elements.classButtonsContainer.innerHTML = buttonsHtml;
            }

            // „ÇØ„É©„Çπ„ÅÆ„Çµ„Éû„É™„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            getClassSummary(group) {
                const classTimeslots = Array.from(this.latestTimeslotMap.values())
                    .filter(timeslot => timeslot.group === group);

                const totalPerformances = classTimeslots.length;
                const totalSeats = classTimeslots.reduce((sum, t) => sum + (t.totalSeats || 0), 0);
                const totalEmptySeats = classTimeslots.reduce((sum, t) => sum + (t.emptySeats || 0), 0);
                const totalOccupiedSeats = classTimeslots.reduce((sum, t) => sum + (t.occupiedSeats || 0), 0);

                return {
                    totalPerformances,
                    totalSeats,
                    totalEmptySeats,
                    totalOccupiedSeats
                };
            }

            // „ÇØ„É©„ÇπÂà•ÂàÜÊûê„ÇíË°®Á§∫
            async showClassAnalysis(group) {
                try {
                    const button = document.querySelector(`[data-group="${group}"]`);
                    if (button) {
                        button.classList.add('loading');
                        button.disabled = true;
                    }

                    console.log(`Starting class analysis for group: ${group}`);

                    // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫„ÇíËøΩÂä†
                    this.showProgress(`„ÇØ„É©„Çπ ${group} „ÅÆÂàÜÊûê„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...`);

                    // Êó¢Â≠ò„Éá„Éº„Çø„Åã„ÇâÂàÜÊûêÔºàAPIÈñ¢Êï∞„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁõ¥Êé•„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊñπÂºè„Çí‰ΩøÁî®Ôºâ
                    const classData = await this.analyzeClassFromExistingData(group);

                    // „Éó„É≠„Ç∞„É¨„Çπ„ÇíÈùûË°®Á§∫
                    this.hideProgress();

                    this.showClassAnalysisModal(group, classData);

                } catch (error) {
                    console.error('Class analysis failed:', error);
                    this.hideProgress();
                    this.showError(`„ÇØ„É©„Çπ ${group} „ÅÆÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                } finally {
                    const button = document.querySelector(`[data-group="${group}"]`);
                    if (button) {
                        button.classList.remove('loading');
                        button.disabled = false;
                    }
                }
            }

            // Êó¢Â≠ò„Éá„Éº„Çø„Åã„Çâ„ÇØ„É©„ÇπÂàÜÊûê„ÇíÂÆüË°å
            async analyzeClassFromExistingData(group) {
                const classTimeslots = Array.from(this.latestTimeslotMap.values())
                    .filter(timeslot => timeslot.group === group);

                const analysis = {
                    group: group,
                    totalPerformances: classTimeslots.length,
                    totalSeats: 0,
                    totalOccupiedSeats: 0,
                    totalEmptySeats: 0,
                    totalReservedSeats: 0,
                    totalCheckedInSeats: 0,
                    performances: [],
                    capacityLevels: {
                        full: 0,
                        critical: 0,
                        warning: 0,
                        normal: 0
                    }
                };

                // ÂêÑÂÖ¨Êºî„ÅÆË©≥Á¥∞„Éá„Éº„Çø„ÇíÈ†ÜÊ¨°ÂèñÂæóÔºàAPIË≤†Ëç∑ËªΩÊ∏õ„ÅÆ„Åü„ÇÅ‰∏¶Ë°åÂÆüË°å„ÇíÂà∂ÈôêÔºâ
                const performances = [];

                for (let i = 0; i < classTimeslots.length; i++) {
                    const timeslot = classTimeslots[i];

                    // Ââç„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâÊ¨°„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈñãÂßã
                    if (i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }

                    try {
                        console.log(`Fetching seat data for ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot}...`);

                        // ÂÆüÈöõ„ÅÆseatMap„Éá„Éº„Çø„ÇíÂèñÂæó
                        const seatData = await this.getDetailedSeatData(timeslot);
                        if (seatData && seatData.length > 0) {
                            console.log(`Successfully got seat data for ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot}: ${seatData.length} seats`);

                            // seatMap„Éá„Éº„Çø„Åã„ÇâÊ≠£Á¢∫„Å™„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥ÊÉÖÂ†±„ÇíË®àÁÆó
                            const seatAnalysis = this.analyzeSeatData(seatData);

                            performances.push({
                                day: timeslot.day,
                                timeslot: timeslot.timeslot,
                                totalSeats: seatAnalysis.totalSeats,
                                occupiedSeats: timeslot.occupiedSeats || 0,
                                emptySeats: seatAnalysis.emptySeats,
                                reservedSeats: seatAnalysis.reservedSeats,
                                checkedInSeats: seatAnalysis.checkedInSeats,
                                checkedInRate: seatAnalysis.checkedInRate,
                                capacityLevel: timeslot.capacityLevel || 'normal',
                                lastChecked: timeslot.lastChecked,
                                dataSource: 'seatMap'
                            });
                        } else {
                            console.log(`No seat data available for ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot}, using fallback`);

                            // seatMap„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÊó¢Â≠ò„Éá„Éº„Çø„Çí‰ΩøÁî®
                            const reservedSeats = timeslot.reservedSeats || 0;
                            const checkedInSeats = timeslot.checkedInSeats || 0;

                            performances.push({
                                day: timeslot.day,
                                timeslot: timeslot.timeslot,
                                totalSeats: timeslot.totalSeats || 0,
                                occupiedSeats: timeslot.occupiedSeats || 0,
                                emptySeats: timeslot.emptySeats || 0,
                                reservedSeats: reservedSeats,
                                checkedInSeats: checkedInSeats,
                                checkedInRate: reservedSeats > 0 ? ((checkedInSeats / reservedSeats) * 100).toFixed(1) : 0,
                                capacityLevel: timeslot.capacityLevel || 'normal',
                                lastChecked: timeslot.lastChecked,
                                dataSource: 'fallback'
                            });
                        }
                    } catch (error) {
                        console.error(`Failed to get detailed data for ${timeslot.day}Êó•ÁõÆ ${timeslot.timeslot}:`, error);

                        // „Ç®„É©„ÉºÊôÇ„ÅØÊó¢Â≠ò„Éá„Éº„Çø„Çí‰ΩøÁî®
                        const reservedSeats = timeslot.reservedSeats || 0;
                        const checkedInSeats = timeslot.checkedInSeats || 0;

                        performances.push({
                            day: timeslot.day,
                            timeslot: timeslot.timeslot,
                            totalSeats: timeslot.totalSeats || 0,
                            occupiedSeats: timeslot.occupiedSeats || 0,
                            emptySeats: timeslot.emptySeats || 0,
                            reservedSeats: reservedSeats,
                            checkedInSeats: checkedInSeats,
                            checkedInRate: reservedSeats > 0 ? ((checkedInSeats / reservedSeats) * 100).toFixed(1) : 0,
                            capacityLevel: timeslot.capacityLevel || 'normal',
                            lastChecked: timeslot.lastChecked,
                            dataSource: 'error'
                        });
                    }
                }

                // ÂàÜÊûê„Éá„Éº„Çø„ÇíÈõÜË®à
                performances.forEach(perf => {
                    analysis.totalSeats += perf.totalSeats;
                    analysis.totalOccupiedSeats += perf.occupiedSeats;
                    analysis.totalEmptySeats += perf.emptySeats;
                    analysis.totalReservedSeats += perf.reservedSeats;
                    analysis.totalCheckedInSeats += perf.checkedInSeats;

                    const capacityLevel = perf.capacityLevel;
                    analysis.capacityLevels[capacityLevel]++;

                    analysis.performances.push(perf);
                });

                // „ÇØ„É©„ÇπÂÖ®‰Ωì„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Áéá„ÇíË®àÁÆó
                analysis.overallCheckedInRate = analysis.totalReservedSeats > 0 ?
                    ((analysis.totalCheckedInSeats / analysis.totalReservedSeats) * 100).toFixed(1) : 0;

                return analysis;
            }

            // „ÇØ„É©„ÇπÂàÜÊûê„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            showClassAnalysisModal(group, analysisData) {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';

                const modal = document.createElement('div');
                modal.className = 'modal-content';

                const header = document.createElement('div');
                header.className = 'modal-header';
                header.innerHTML = `
                    <h2 class="modal-title">${group}ÁµÑ - „ÇØ„É©„ÇπÂà•ÂàÜÊûê</h2>
                    <button class="modal-close">&times;</button>
                `;

                const body = document.createElement('div');
                body.className = 'modal-body';

                // ÂàÜÊûê„Éá„Éº„Çø„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                this.renderClassAnalysisContent(body, analysisData);

                modal.appendChild(header);
                modal.appendChild(body);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
                const closeBtn = header.querySelector('.modal-close');
                const closeModal = () => {
                    overlay.remove();
                };
                closeBtn.addEventListener('click', closeModal);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeModal();
                });
            }

            // „ÇØ„É©„ÇπÂàÜÊûê„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderClassAnalysisContent(body, analysisData) {
                const occupancyRate = analysisData.totalSeats > 0 ?
                    ((analysisData.totalOccupiedSeats / analysisData.totalSeats) * 100).toFixed(1) : 0;

                body.innerHTML = `
                    <div class="performance-details">
                        <div class="detail-card reserved">
                            <h4>„ÇØ„É©„ÇπÂÖ®‰Ωì„Çµ„Éû„É™„Éº</h4>
                            <div class="detail-stats">
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalPerformances}</p>
                                    <p class="stat-label">ÂÖ¨ÊºîÊï∞</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalSeats}</p>
                                    <p class="stat-label">Á∑èÂ∫ßÂ∏≠Êï∞</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalOccupiedSeats}</p>
                                    <p class="stat-label">Âà©Áî®‰∏≠Â∫ßÂ∏≠</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalEmptySeats}</p>
                                    <p class="stat-label">Á©∫Â∏≠Êï∞</p>
                                </div>
                            </div>
                            <div class="occupancy-rate">
                                Âà©Áî®Áéá: ${occupancyRate}%
                            </div>
                        </div>
                        
                        <div class="detail-card checked-in">
                            <h4>„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Áä∂Ê≥Å</h4>
                            <div class="detail-stats">
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalReservedSeats || 0}</p>
                                    <p class="stat-label">‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.totalCheckedInSeats || 0}</p>
                                    <p class="stat-label">„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„Åø</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.overallCheckedInRate || 0}%</p>
                                    <p class="stat-label">„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Áéá</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${(analysisData.totalReservedSeats || 0) - (analysisData.totalCheckedInSeats || 0)}</p>
                                    <p class="stat-label">Êú™„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥</p>
                                </div>
                            </div>
                            <div class="checkin-rate-info">
                                ‰∫àÁ¥ÑÊ∏à„ÅøÂ∫ßÂ∏≠„Å´ÂØæ„Åô„Çã„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Áéá: ${analysisData.overallCheckedInRate || 0}%
                            </div>
                        </div>
                        
                        <div class="detail-card warning">
                            <h4>„Çπ„ÉÜ„Éº„Çø„ÇπÂàÜÂ∏É</h4>
                            <div class="detail-stats">
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.capacityLevels.full}</p>
                                    <p class="stat-label">Ê∫ÄÂ∏≠</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.capacityLevels.critical}</p>
                                    <p class="stat-label">Á∑äÊÄ•</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.capacityLevels.warning}</p>
                                    <p class="stat-label">Ë≠¶Âëä</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-value">${analysisData.capacityLevels.normal}</p>
                                    <p class="stat-label">Ê≠£Â∏∏</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">ÂÖ¨ÊºîË©≥Á¥∞‰∏ÄË¶ß</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${this.renderPerformanceList(analysisData.performances)}
                        </div>
                    </div>
                    
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #004085;">‚ÑπÔ∏è ÂàÜÊûêÊÉÖÂ†±</h4>
                        <p style="margin: 0; color: #004085; font-size: 14px;">
                            ÂàÜÊûêÊôÇÂàª: ${new Date().toLocaleString('ja-JP')}<br>
                            ÂØæË±°„ÇØ„É©„Çπ: ${analysisData.group}ÁµÑ<br>
                            ÂàÜÊûêÂØæË±°ÂÖ¨ÊºîÊï∞: ${analysisData.totalPerformances}‰ª∂<br>
                            „Éá„Éº„Çø„ÇΩ„Éº„Çπ: ${this.getDataSourceSummary(analysisData.performances)}<br>
                            „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥ÁéáË®àÁÆó: API„ÅÆseatMap„Éá„Éº„Çø„Åã„ÇâCÂàó„Äå‰∫àÁ¥ÑÊ∏à„Äç„Åã„Å§EÂàó„ÄåÊ∏à„Äç„ÇíÊ≠£Á¢∫„Å´Âà§ÂÆö<br>
                            ÂàÜÊûêÁ≤æÂ∫¶: ${this.getAnalysisAccuracy(analysisData.performances)}
                        </p>
                    </div>
                `;
            }

            // „Éá„Éº„Çø„ÇΩ„Éº„Çπ„Çµ„Éû„É™„Éº„ÇíÂèñÂæó
            getDataSourceSummary(performances) {
                if (!performances || performances.length === 0) {
                    return '„Éá„Éº„Çø„Å™„Åó';
                }

                const sourceCounts = performances.reduce((acc, perf) => {
                    const source = perf.dataSource || 'unknown';
                    acc[source] = (acc[source] || 0) + 1;
                    return acc;
                }, {});

                const sourceLabels = {
                    'seatMap': 'API (seatMap)',
                    'fallback': 'Êé®ÂÆö„Éá„Éº„Çø',
                    'error': '„Ç®„É©„ÉºÊôÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ',
                    'unknown': '‰∏çÊòé'
                };

                return Object.entries(sourceCounts)
                    .map(([source, count]) => `${sourceLabels[source] || source}: ${count}‰ª∂`)
                    .join(', ');
            }

            // ÂàÜÊûêÁ≤æÂ∫¶„ÇíÂèñÂæó
            getAnalysisAccuracy(performances) {
                if (!performances || performances.length === 0) {
                    return '„Éá„Éº„Çø„Å™„Åó';
                }

                const seatMapCount = performances.filter(p => p.dataSource === 'seatMap').length;
                const totalCount = performances.length;
                const accuracy = totalCount > 0 ? Math.round((seatMapCount / totalCount) * 100) : 0;

                if (accuracy >= 80) {
                    return `È´òÁ≤æÂ∫¶ (${accuracy}%„ÅåAPI„Éá„Éº„Çø)`;
                } else if (accuracy >= 50) {
                    return `‰∏≠Á≤æÂ∫¶ (${accuracy}%„ÅåAPI„Éá„Éº„Çø)`;
                } else {
                    return `‰ΩéÁ≤æÂ∫¶ (${accuracy}%„ÅåAPI„Éá„Éº„Çø) - Êé®ÂÆö„Éá„Éº„Çø„ÅåÂ§ö„ÅÑ`;
                }
            }

            // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫
            showProgress(message) {
                // Êó¢Â≠ò„ÅÆ„Éó„É≠„Ç∞„É¨„Çπ„ÇíÂâäÈô§
                this.hideProgress();

                const progressDiv = document.createElement('div');
                progressDiv.id = 'class-analysis-progress';
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    z-index: 10000;
                    text-align: center;
                    font-size: 16px;
                `;
                progressDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">${message}</div>
                    <div style="width: 200px; height: 4px; background: #333; border-radius: 2px; overflow: hidden;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s ease;"></div>
                    </div>
                `;

                document.body.appendChild(progressDiv);

                // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                setTimeout(() => {
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                }, 100);
            }

            // „Éó„É≠„Ç∞„É¨„ÇπÈùûË°®Á§∫
            hideProgress() {
                const progressDiv = document.getElementById('class-analysis-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
            }

            // ÂÖ¨Êºî‰∏ÄË¶ß„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderPerformanceList(performances) {
                if (!performances || performances.length === 0) {
                    return '<p style="text-align: center; color: #666; padding: 20px;">ÂÖ¨Êºî„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                }

                return performances.map(perf => {
                    const capacityLevelText = this.getCapacityLevelText(perf.capacityLevel);
                    const lastChecked = perf.lastChecked ? new Date(perf.lastChecked).toLocaleString('ja-JP') : '-';

                    return `
                        <div style="border: 1px solid #e1e5e9; border-left: 4px solid ${this.getCapacityLevelColor(perf.capacityLevel)}; border-radius: 8px; padding: 12px; margin: 8px 0; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: 600;">${perf.day}Êó•ÁõÆ ${perf.timeslot}</div>
                                <span style="font-size: 12px; color: #666;">${lastChecked}</span>
                            </div>
                            <div style="margin-top: 8px; color: #333;">
                                <div>„Çπ„ÉÜ„Éº„Çø„Çπ: ${capacityLevelText}</div>
                                <div>Â∫ßÂ∏≠Áä∂Ê≥Å: ${perf.occupiedSeats}/${perf.totalSeats} (Á©∫Â∏≠: ${perf.emptySeats}Â∏≠)</div>
                                <div style="margin-top: 4px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                                    <strong>„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Áä∂Ê≥Å:</strong> ‰∫àÁ¥ÑÊ∏à„Åø ${perf.reservedSeats || 0}Â∏≠ / „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Ê∏à„Åø ${perf.checkedInSeats || 0}Â∏≠ 
                                    <span style="color: #27ae60; font-weight: 600;">(${perf.checkedInRate || 0}%)</span>
                                    ${perf.dataSource ? `<br><small style="color: #666;">„Éá„Éº„Çø„ÇΩ„Éº„Çπ: ${perf.dataSource === 'seatMap' ? 'API (seatMap)' : perf.dataSource === 'fallback' ? 'Êé®ÂÆö„Éá„Éº„Çø' : '„Ç®„É©„ÉºÊôÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ'}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Éô„É´„Å´ÂØæÂøú„Åô„ÇãËâ≤„ÇíÂèñÂæó
            getCapacityLevelColor(level) {
                switch (level) {
                    case 'full': return '#e74c3c';
                    case 'critical': return '#f39c12';
                    case 'warning': return '#f1c40f';
                    default: return '#27ae60';
                }
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkNetworkConnection() {
                try {
                    // navigator.onLine „Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (typeof navigator !== 'undefined' && navigator.onLine === false) {
                        return false;
                    }

                    // ËøΩÂä†„ÅÆ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                    return true;
                } catch (error) {
                    console.warn('Network check failed:', error);
                    return true; // „ÉÅ„Çß„ÉÉ„ÇØ„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÊé•Á∂ö„ÅÇ„Çä„Å®‰ªÆÂÆö
                }
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
            isNetworkError(error) {
                if (!error) return false;

                const errorMessage = error.message || error.toString();
                const networkErrorPatterns = [
                    'ERR_NAME_NOT_RESOLVED',
                    'ERR_NETWORK_CHANGED',
                    'ERR_INTERNET_DISCONNECTED',
                    'ERR_NETWORK_ACCESS_DENIED',
                    'ERR_CONNECTION_REFUSED',
                    'ERR_CONNECTION_TIMED_OUT',
                    'ERR_CONNECTION_RESET',
                    'ERR_ADDRESS_UNREACHABLE',
                    'ERR_NETWORK_UNREACHABLE',
                    'timeout',
                    'network',
                    'offline'
                ];

                return networkErrorPatterns.some(pattern =>
                    errorMessage.toLowerCase().includes(pattern.toLowerCase())
                );
            }

            // „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„ÅÆÂá¶ÁêÜ
            async handleOfflineMode() {
                console.log('Offline mode detected');

                // „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆË°®Á§∫
                this.elements.timeslotsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ</h3>
                        <p>„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                        <p>Êé•Á∂ö„ÅåÂæ©Êóß„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åô„ÄÇ</p>
                        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ÂÜçË©¶Ë°å
                        </button>
                    </div>
                `;

                // „ÇØ„É©„ÇπÂà•ÂàÜÊûê„ÇÇ„Ç™„Éï„É©„Ç§„É≥Ë°®Á§∫
                if (this.elements.classButtonsContainer) {
                    this.elements.classButtonsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„ÅÆ„Åü„ÇÅ„ÄÅ„ÇØ„É©„ÇπÂàÜÊûê„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ</p>
                        </div>
                    `;
                }

                // ÂÆöÊúüÁöÑ„Å´Êé•Á∂ö„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                this.startOfflineReconnectionCheck();
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅÆÂá¶ÁêÜ
            async handleNetworkError(error) {
                console.error('Network error detected:', error);

                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
                this.showNetworkStatus('error', this.getNetworkErrorMessage(error));

                // „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (window.OfflineSyncV2 && window.OfflineSyncV2.addOperation) {
                    console.log('Offline sync system available, delegating operations');
                    // „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„Å´ÂßîË≠≤
                    await this.delegateToOfflineSync();
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
                    await this.loadWithFallback('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅÆ„Åü„ÇÅ„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô');
                }
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
            getNetworkErrorMessage(error) {
                const errorMessage = error.message || error.toString();

                if (errorMessage.includes('ERR_NAME_NOT_RESOLVED')) {
                    return 'DNSËß£Ê±∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else if (errorMessage.includes('ERR_NETWORK_CHANGED')) {
                    return '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü„ÄÇ';
                } else if (errorMessage.includes('timeout')) {
                    return 'Êé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ';
                } else if (errorMessage.includes('offline')) {
                    return '„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„Åß„Åô„ÄÇ';
                } else {
                    return '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                }
            }

            // „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„Å´ÂßîË≠≤
            async delegateToOfflineSync() {
                try {
                    console.log('Delegating to offline sync system');

                    // „Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„Å´Êìç‰Ωú„ÇíËøΩÂä†
                    if (window.OfflineSyncV2.addOperation) {
                        await window.OfflineSyncV2.addOperation('getDetailedCapacityAnalysis', [null, null, null]);
                    }

                    // „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆË°®Á§∫
                    this.elements.timeslotsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>„Ç™„Éï„É©„Ç§„É≥ÂêåÊúü‰∏≠</h3>
                            <p>„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅåÂæ©Êóß„Åô„Çã„Å®„ÄÅ„Éá„Éº„Çø„ÅåÂêåÊúü„Åï„Çå„Åæ„Åô„ÄÇ</p>
                            <p>„Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„ÅåÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Failed to delegate to offline sync:', error);
                    await this.loadWithFallback('„Ç™„Éï„É©„Ç§„É≥ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }

            // „Ç™„Éï„É©„Ç§„É≥ÂÜçÊé•Á∂ö„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã
            startOfflineReconnectionCheck() {
                if (this.offlineCheckInterval) {
                    clearInterval(this.offlineCheckInterval);
                }

                this.offlineCheckInterval = setInterval(async () => {
                    if (this.checkNetworkConnection()) {
                        console.log('Network connection restored');
                        clearInterval(this.offlineCheckInterval);
                        this.offlineCheckInterval = null;

                        // Êé•Á∂öÂæ©ÊóßÊôÇ„ÅÆÂá¶ÁêÜ
                        this.showNetworkStatus('success', '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅåÂæ©Êóß„Åó„Åæ„Åó„Åü');
                        this.showSuccess('„Éá„Éº„Çø„ÇíÂÜçÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô...');
                        await this.loadInitialData();
                    }
                }, 5000); // 5Áßí„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„ÇíË°®Á§∫
            showNetworkStatus(type, message) {
                if (!this.elements.networkStatus || !this.elements.networkStatusText) return;

                this.elements.networkStatus.className = `network-status-indicator ${type}`;
                this.elements.networkStatusText.textContent = message;
                this.elements.networkStatus.style.display = 'block';

                // ÊàêÂäü„ÅÆÂ†¥Âêà„ÅØ3ÁßíÂæå„Å´ÈùûË°®Á§∫
                if (type === 'success') {
                    setTimeout(() => {
                        if (this.elements.networkStatus) {
                            this.elements.networkStatus.style.display = 'none';
                        }
                    }, 3000);
                }
            }

            // Êé•Á∂öÂÜçË©¶Ë°å
            async retryConnection() {
                if (!this.elements.networkStatusText) return;

                this.elements.networkStatusText.textContent = 'Êé•Á∂ö„ÇíÂÜçË©¶Ë°å‰∏≠...';
                this.elements.networkStatus.className = 'network-status-indicator';

                try {
                    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.checkNetworkConnection()) {
                        this.showNetworkStatus('success', 'Êé•Á∂ö„ÅåÂæ©Êóß„Åó„Åæ„Åó„Åü');
                        await this.loadInitialData();
                    } else {
                        this.showNetworkStatus('error', 'Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                } catch (error) {
                    console.error('Connection retry failed:', error);
                    this.showNetworkStatus('error', `Êé•Á∂ö„Ç®„É©„Éº: ${error.message}`);
                }
            }
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíÂàùÊúüÂåñ
        const dashboard = new MonitoringDashboard();

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.MonitoringDashboard = dashboard;
    </script>
</body>

</html>