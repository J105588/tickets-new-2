<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>座席管理システム - 操作ログ</title>
  <meta name="description" content="GASを経由した全操作ログの詳細表示">
  <meta name="theme-color" content="#007bff">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="icon" type="image/png"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="座席管理システム">
  <link rel="apple-touch-icon"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="180x180"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="152x152"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="144x144"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="120x120"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="114x114"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="76x76"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="72x72"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="60x60"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <link rel="apple-touch-icon" sizes="57x57"
    href="https://lh3.googleusercontent.com/a/ACg8ocJIgKhq2qCWSld0Kx1pBDyJxosdON3XvHd2th1B4CrPkFRN82M=s360-c-no">
  <meta name="msapplication-TileColor" content="#007bff">
  <meta name="msapplication-config" content="browserconfig.xml">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/sidebar.css">
  <link rel="stylesheet" href="../assets/css/logs.css">
  <script>
    (async () => {
      try {
        const res = await fetch('../manifest.json', { cache: 'no-store' });
        const manifest = await res.json();
        const bg = (manifest && (manifest.background_color || manifest.theme_color)) || null;
        if (!bg) return;
        const theme = bg;
        const isWhite = (typeof bg === 'string') && (/^#?([fF]{3}|[fF]{6})$/.test(bg) || bg.toLowerCase() === 'white');
        const pageBg = isWhite ? '#f5f6f8' : bg;
        let themeMeta = document.querySelector('meta[name="theme-color"]');
        if (!themeMeta) {
          themeMeta = document.createElement('meta');
          themeMeta.setAttribute('name', 'theme-color');
          document.head.appendChild(themeMeta);
        }
        themeMeta.setAttribute('content', theme);
        try { document.documentElement.style.backgroundColor = pageBg; } catch (_) { }
        try { document.body && (document.body.style.backgroundColor = pageBg); } catch (_) { }
        const toRgb = (hex) => {
          const h = hex.replace('#', '').trim();
          if (h.length === 3) return [h[0] + h[0], h[1] + h[1], h[2] + h[2]].map(v => parseInt(v, 16));
          if (h.length === 6) return [h.substring(0, 2), h.substring(2, 4), h.substring(4, 6)].map(v => parseInt(v, 16));
          return null;
        };
        const rgb = /^#?[0-9a-fA-F]{3,6}$/.test(theme) ? toRgb(theme) : null;
        if (rgb) {
          const [r, g, b] = rgb.map(v => v / 255);
          const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
          const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
          if (appleMeta) appleMeta.setAttribute('content', luminance < 0.5 ? 'black' : 'default');
        }
      } catch (_) { }
    })();
  </script>
</head>

<body>

  <div id="sidebar-container"></div>

  <!-- オフライン状態インジケーター -->
  <div id="offline-indicator" class="offline-indicator" style="display: none;">オフライン</div>

  <!-- 同期進行状況バー -->
  <div id="sync-progress-bar" class="sync-progress-bar" style="display: none;">
    <div class="progress"></div>
  </div>

  <div id="main-content">
    <header class="page-header">
      <button class="menu-btn" onclick="toggleSidebar()">&#9776;</button>
      <h1>操作ログ</h1>
      <div class="header-actions" style="margin-left:auto; display:flex; gap:8px;">
        <button id="refresh-btn" class="btn-primary" onclick="refreshLogs()">更新</button>
        <button id="auto-refresh-btn" class="btn-secondary" onclick="toggleAutoRefresh()">自動更新: OFF</button>
      </div>
    </header>

    <main class="container" id="logs-root" style="display:none;">
      <!-- 統計情報 -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-number" id="total-operations">-</div>
          <div class="stat-label">総操作数</div>
        </div>
        <div class="stat-card success">
          <div class="stat-number" id="success-count">-</div>
          <div class="stat-label">成功</div>
        </div>
        <div class="stat-card error">
          <div class="stat-number" id="error-count">-</div>
          <div class="stat-label">エラー</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="last-update">-</div>
          <div class="stat-label">最終更新</div>
        </div>
        <div class="stat-card" id="full-capacity-card" style="display: none;">
          <div class="stat-number" id="full-capacity-count">-</div>
          <div class="stat-label">満席公演</div>
        </div>
      </div>

      <!-- フィルター -->
      <div class="filter-container">
        <div class="filter-group">
          <label for="operation-filter">操作:</label>
          <select id="operation-filter">
            <option value="">すべて</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="status-filter">ステータス:</label>
          <select id="status-filter">
            <option value="">すべて</option>
            <option value="SUCCESS">成功</option>
            <option value="ERROR">エラー</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="text-filter">キーワード:</label>
          <input id="text-filter" type="text" placeholder="type/action/メタ/UA/IP を検索" />
        </div>
        <div class="filter-group">
          <label>期間:</label>
          <div style="display:flex; gap:6px; align-items:center;">
            <input id="date-start" type="date" />
            <span>〜</span>
            <input id="date-end" type="date" />
          </div>
        </div>
        <div class="filter-group">
          <label for="limit-filter">表示件数:</label>
          <select id="limit-filter">
            <option value="50">50件</option>
            <option value="100" selected>100件</option>
            <option value="200">200件</option>
            <option value="500">500件</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="error-highlight-toggle">エラー強調:</label>
          <input id="error-highlight-toggle" type="checkbox" checked />
        </div>
        <div class="filter-group">
          <label for="full-capacity-notification-toggle">満席通知:</label>
          <input id="full-capacity-notification-toggle" type="checkbox" />
        </div>
        <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
          <button class="btn-primary" onclick="applyFilters()">フィルター適用</button>
          <button class="btn-secondary" onclick="clearFilters()">クリア</button>
          <button class="btn-secondary" onclick="exportLogsCSV()">CSV出力</button>
          <button class="btn-secondary" onclick="showFullCapacitySettings()">満席通知設定</button>
        </div>
      </div>

      <!-- ログテーブル -->
      <div class="logs-container">
        <div id="full-alert"
          style="display:none;padding:12px 16px;margin:12px 16px;border-left:4px solid #dc3545;background:#fff5f5;color:#721c24;border-radius:6px;">
          満席通知を受信しました</div>
        <div class="logs-header">
          <h3>操作ログ一覧</h3>
          <div class="logs-info">
            <span id="logs-count">0件</span>
            <span id="logs-loading" style="display: none;">読み込み中...</span>
          </div>
        </div>

        <div class="table-container">
          <table class="logs-table">
            <thead>
              <tr>
                <th>タイムスタンプ</th>
                <th>種別</th>
                <th>アクション</th>
                <th>メタデータ</th>
                <th>セッション</th>
                <th>IPアドレス</th>
                <th>詳細</th>
              </tr>
            </thead>
            <tbody id="logs-table-body">
              <tr>
                <td colspan="7" class="no-data">データを読み込み中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- エクスポート進捗表示 -->
  <div id="export-progress-container" class="export-progress-container">
    <div class="export-progress-bar">
      <div class="progress"></div>
    </div>
    <div id="export-progress-text" class="export-progress-text">エクスポート準備中...</div>
  </div>

  <!-- 満席通知設定モーダル -->
  <div id="full-capacity-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>満席通知設定</h3>
        <button class="close-btn" onclick="closeFullCapacitySettings()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="detail-section">
          <h4>通知設定</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>通知メールアドレス（固定）:</label>
              <div id="notification-emails-display"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; font-family: monospace; white-space: pre-line;">
                読み込み中...</div>
              <small style="color: #666; font-size: 12px;">メールアドレスはシステム管理者により設定されています</small>
            </div>
            <div class="detail-item">
              <label for="notification-enabled">通知を有効にする:</label>
              <input type="checkbox" id="notification-enabled" />
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>監視設定</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label for="check-interval">チェック間隔:</label>
              <select id="check-interval"
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="15000">15秒</option>
                <option value="30000" selected>30秒</option>
                <option value="60000">1分</option>
                <option value="300000">5分</option>
              </select>
            </div>
            <div class="detail-item">
              <label>現在の状態:</label>
              <span id="monitor-status">停止中</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>テスト</h4>
          <div style="display: flex; gap: 10px;">
            <button class="btn-primary" onclick="testFullCapacityNotification()">テスト通知</button>
            <button class="btn-secondary" onclick="manualFullCapacityCheck()">手動チェック</button>
          </div>
        </div>
      </div>
      <div class="modal-buttons"
        style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn-primary" onclick="saveFullCapacitySettings()">保存</button>
        <button class="btn-secondary" onclick="closeFullCapacitySettings()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- ログ詳細モーダル -->
  <div id="log-detail-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ログ詳細</h3>
        <button class="close-btn" onclick="closeLogDetail()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="detail-section">
          <h4>基本情報</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>タイムスタンプ:</label>
              <span id="detail-timestamp">-</span>
            </div>
            <div class="detail-item">
              <label>操作:</label>
              <span id="detail-operation">-</span>
            </div>
            <div class="detail-item">
              <label>ステータス:</label>
              <span id="detail-status">-</span>
            </div>
            <div class="detail-item">
              <label>IPアドレス:</label>
              <span id="detail-ip">-</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>パラメータ</h4>
          <pre id="detail-parameters" class="json-display">-</pre>
        </div>

        <div class="detail-section">
          <h4>結果</h4>
          <pre id="detail-result" class="json-display">-</pre>
        </div>

        <div class="detail-section">
          <h4>ユーザーエージェント</h4>
          <div id="detail-useragent" class="user-agent">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- エラー表示 -->
  <div id="error-container" class="error-container" style="display: none;">
    <div class="error-content">
      <p id="error-message">エラーが発生しました</p>
      <div class="error-buttons">
        <button onclick="location.reload()">再読み込み</button>
      </div>
    </div>
  </div>

  <!-- ローディングモーダル -->
  <div id="loading-modal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="spinner"></div>
      <p>処理中です...</p>
    </div>
  </div>

  <!-- スクリプト -->
  <script>
    (function gateLogs() {
      try {
        const params = new URLSearchParams(location.search);
        const auth = params.get('auth');
        const token = localStorage.getItem('superadminToken') || '1';
        const ok = auth && token && auth === token;
        if (!ok) {
          document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#b00020;font-weight:bold;">権限がありません</div>';
          return;
        }
        document.getElementById('logs-root').style.display = '';
      } catch (e) {
        document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#b00020;font-weight:bold;">権限がありません</div>';
      }
    })();
  </script>
  <script type="module" src="../assets/js/logs-main.js"></script>

  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('../sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // Service Workerからのリロードメッセージを処理
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'RELOAD') {
          window.location.reload();
        }
      });
    }
  </script>
</body>

</html>